<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Downtown - ADC Generator</title>
  <style>
    body {
      font-family: 'Noto Sans KR', Arial, sans-serif;
      background-color: #fafafa;
      margin: 0;
      padding: 2rem;
    }
    .top-buttons {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      max-width: 420px;
    }
    .top-buttons button {
      flex: 1;
      padding: 0.75rem 0;
      border: none;
      color: white;
      font-weight: bold;
      font-size: 1.2rem;
      border-radius: 6px;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .top-buttons button:not(.active) {
      opacity: 0.6;
    }
    .us { background-color: #2b6cb0; }
    .drv { background-color: #e53e3e; }

    h2 {
      margin-top: 0.5rem;
      margin-bottom: 1rem;
      font-size: 1.3rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 2rem;
      font-size: 0.9rem;
      table-layout: auto; /* 너비 자동 조절을 위해 변경 */
    }

    th, td {
      border: 1px solid #bdbdbd;
      padding: 0.45rem;
      text-align: center;
      overflow: hidden;
      white-space: normal; /* 글자 줄바꿈 허용 */
    }

    th {
      background-color: #e6e6e6;
      font-weight: 600;
    }

    .lead { background-color: #e9f7fe; }
    .main { background-color: #fff0e6; }
    .trail { background-color: #e9f6ec; }

    .add-row {
      cursor: pointer;
      font-size: 1.2rem;
      color: #333;
      border: none;
      background: none;
      padding: 0.6rem 0;
    }

    .view-btn {
      background-color: #f3f3f3;
      border: 1px solid #bdbdbd;
      border-radius: 4px;
      padding: 0.2rem 0.5rem;
      cursor: pointer;
    }
    .delete-row {
      cursor: pointer;
      font-size: 1.2rem;
      color: #e53e3e;
      border: 1px solid #f56565;
      background-color: #fff5f5;
      border-radius: 4px;
      padding: 0.2rem 0.5rem;
      font-size: 0.85rem;
    }

    .input-box {
      display: grid;
      grid-template-columns: 80px 1fr;
      gap: 0.3rem;
      width: 360px;
      margin-bottom: 1.2rem;
    }

    .input-box label {
      background-color: #d9eaf7;
      padding: 0.3rem;
      text-align: center;
      border: 1px solid #bbb;
    }

    .input-box input {
      border: 1px solid #bbb;
      padding: 0.3rem;
    }

    td select, td input[type="text"] {
      width: 100%;
      border: 1px solid #ccc;
      background-color: white;
      padding: 0.2rem;
      border-radius: 3px;
      font-size: 0.85rem;
      box-sizing: border-box;
    }
    
    /* JS로 너비가 조절될 select를 위한 스타일 */
    td select.fit-width {
        width: auto;
        min-width: 80px;
    }

    /* Modal Styles */
    .modal {
      display: none; /* Hidden by default */
      position: absolute; /* Position relative to the page */
      z-index: 1000; /* Sit on top */
      background-color: #fefefe;
      border: 1px solid #888;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      padding: 20px;
    }

    .modal-content {
      max-width: 2400px; /* Max width increased 3x */
      position: relative;
      text-align: center;
    }

    #modal-image {
      max-height: 90vh; /* Increased max height */
    }

    .close-btn {
      color: #aaa;
      position: absolute;
      top: 10px;
      right: 25px;
      font-size: 35px;
      font-weight: bold;
      cursor: pointer;
    }

    /* 2x2 상태 그리드 스타일 */
    .status-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2px;
      align-items: center;
      padding: 0;
    }
    .status-grid label {
      font-size: 0.8em;
      margin-bottom: -2px;
    }
    .status-grid select {
      width: 100%;
    }

    /* 특정 열의 텍스트 박스 크기 조절 */
    #us-lead-table td:nth-child(n+8):nth-child(-n+11) input, /* 기총, IRM, RHM, 폭탄 */
    #us-main-table td:nth-child(n+8):nth-child(-n+11) input,
    #us-trail-table td:nth-child(n+8):nth-child(-n+11) input,
    #drv-table td:nth-child(n+6):nth-child(-n+9) input,
    #us-lead-table td:nth-child(12) input, /* 연료 */
    #us-main-table td:nth-child(12) input,
    #us-trail-table td:nth-child(12) input,
    #drv-table td:nth-child(10) input {
      width: 40px;
    }

    /* 콜싸인, 비고 텍스트 박스 크기 조절 */
    #us-lead-table td:nth-child(3) input,
    #us-main-table td:nth-child(3) input,
    #us-trail-table td:nth-child(3) input,
    #drv-table td:nth-child(1) input,
    #us-lead-table td:nth-child(13) input,
    #us-main-table td:nth-child(13) input,
    #us-trail-table td:nth-child(13) input,
    #drv-table td:nth-child(11) input {
      width: 80px;
    }

  </style>
</head>
<body>

  <div class="top-buttons">
    <button class="us" id="us-btn">US</button>
    <button class="drv" id="drv-btn">DRV</button>
  </div>

  <div id="us-content" style="display: none;">
    <h2>미군 비행대 생성기</h2>

    <div class="input-box">
      <label>날짜</label><input type="text" placeholder="YYYY-MM-DD" />
      <label>표적</label><input type="text" placeholder="목표 지점" />
    </div>

    <!-- 선발 공격대 -->
    <table class="lead" id="us-lead-table">
      <thead>
        <tr><th colspan="15">선발 공격대</th></tr>
        <tr>
          <th>임무</th><th>태스크</th><th>콜싸인</th><th>항공기 유형</th><th>수준</th><th>공격성</th><th>상태</th><th>기총</th><th>IRM</th><th>RHM</th><th>폭탄</th><th>연료</th><th>비고</th><th>ADC</th><th>삭제</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            <select class="fit-width">
              <option>타격</option><option>아이언 핸드</option><option>채프</option><option selected>재밍</option><option>CSAR</option><option>정찰</option><option>MiGCAP</option>
            </select>
          </td>
          <td>
            <select class="fit-width">
              <option>폭격</option><option>SEAD</option><option>CAP</option><option>무장 호위</option><option>구조 지원</option><option>정찰</option><option selected>재밍</option><option>채프 살포</option><option>타격</option>
            </select>
          </td>
          <td><input type="text" value="Alpha"></td>
          <td>
            <select><option>A-1H Skyraider [US]</option><option>A-4C Skyhawk [US]</option><option>A-4E:F Skyhawk [US]</option><option>A-6A Intruder [US]</option><option>A-6B Intruder [US]</option><option>A-6C Intruder [US]</option><option>A-7A:B Corsair || [US]</option><option>A-7C:E Corsair || [US]</option><option>A-7D Corsair || [US]</option><option>B-52D Stratofortress [US]</option><option>B-52G Stratofortress [US]</option><option>Canberra MK.20 [AUS]</option><option>EA-1F Electric SPAD [US]</option><option>EA-6A Intruder [US]</option><option selected>EA-6B Prowler [US]</option><option>EB-66B [US]</option><option>EB-66E [US]</option><option>EF-10B Skynight [US]</option><option>EKA-3B Skywarrior [US]</option><option>F-100D Super Sabre [US]</option><option>F-100F Wild Weasel | [US]</option><option>F-104C Starfighter [US]</option><option>F-105F ThunderChief(2) [US]</option><option>F-105F Thunderchief [US]</option><option>F-105F Wild Weasel ||| [US]</option><option>F-105G Wild Weasel [US]</option><option>F-105G Wild Weasel(2) [US]</option><option>F-111A Aardvark [US]</option><option>F-14A Tomcat [US]</option><option>F-4B Phantom || [US]</option><option>F-4C Wild Weasel |V [US]</option><option>F-4D Phantom || [US]</option><option>F-4E Phantom || [US]</option><option>F-4J Phantom || [US]</option><option>F-4N Phantom || [US]</option><option>F-8C:D Crusader [US]</option><option>F-8E:H:J Crusader [US]</option><option>Mirage |||0(F) [AUS]</option><option>RA-5C Vigilante [US]</option><option>RF-4B Phantom || [US]</option><option>RF-8A:G Crusader [US]</option><option>RF1-1C Voodoo [US]</option></select>
          </td>
          <td>
            <select><option>신병</option><option>훈련됨</option><option>정규군</option><option selected>베테랑</option><option>탑건</option></select>
          </td>
          <td>0</td>
          <td>
            <div class="status-grid">
              <label>#1</label><label>#2</label>
              <select><option selected></option><option>D</option><option>C</option><option>K</option></select>
              <select><option selected></option><option>D</option><option>C</option><option>K</option></select>
              <label>#3</label><label>#4</label>
              <select><option selected></option><option>D</option><option>C</option><option>K</option></select>
              <select><option selected></option><option>D</option><option>C</option><option>K</option></select>
            </div>
          </td>
          <td><input type="text" value=""></td>
          <td><input type="text" value=""></td>
          <td><input type="text" value=""></td>
          <td><input type="text" value=""></td>
          <td><input type="text" value=""></td>
          <td><input type="text" value=""></td>
          <td>
            <button class="view-btn">보기</button>
          </td><td></td>
        </tr>
        <tr><td colspan="15"><button class="add-row" data-target="us-lead-table">+</button></td></tr>
      </tbody>
    </table>

    <!-- 주 공격대 -->
    <table class="main" id="us-main-table">
      <thead>
        <tr><th colspan="15">주 공격대</th></tr>
        <tr>
          <th>임무</th><th>태스크</th><th>콜싸인</th><th>항공기 유형</th><th>수준</th><th>공격성</th><th>상태</th><th>기총</th><th>IRM</th><th>RHM</th><th>폭탄</th><th>연료</th><th>비고</th><th>ADC</th><th>삭제</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            <select class="fit-width">
              <option>타격</option><option selected>아이언 핸드</option><option>채프</option><option>재밍</option><option>CSAR</option><option>정찰</option><option>MiGCAP</option>
            </select>
          </td>
          <td>
            <select class="fit-width">
              <option>폭격</option><option selected>SEAD</option><option>CAP</option><option>무장 호위</option><option>구조 지원</option><option>정찰</option><option>재밍</option><option>채프 살포</option><option>타격</option>
            </select>
          </td>
          <td><input type="text" value="Bravo"></td>
          <td>
            <select><option>A-1H Skyraider [US]</option><option>A-4C Skyhawk [US]</option><option>A-4E:F Skyhawk [US]</option><option>A-6A Intruder [US]</option><option>A-6B Intruder [US]</option><option>A-6C Intruder [US]</option><option>A-7A:B Corsair || [US]</option><option>A-7C:E Corsair || [US]</option><option>A-7D Corsair || [US]</option><option>B-52D Stratofortress [US]</option><option>B-52G Stratofortress [US]</option><option>Canberra MK.20 [AUS]</option><option>EA-1F Electric SPAD [US]</option><option>EA-6A Intruder [US]</option><option>EA-6B Prowler [US]</option><option>EB-66B [US]</option><option>EB-66E [US]</option><option>EF-10B Skynight [US]</option><option>EKA-3B Skywarrior [US]</option><option>F-100D Super Sabre [US]</option><option>F-100F Wild Weasel | [US]</option><option>F-104C Starfighter [US]</option><option>F-105F ThunderChief(2) [US]</option><option>F-105F Thunderchief [US]</option><option>F-105F Wild Weasel ||| [US]</option><option>F-105G Wild Weasel [US]</option><option>F-105G Wild Weasel(2) [US]</option><option>F-111A Aardvark [US]</option><option>F-14A Tomcat [US]</option><option>F-4B Phantom || [US]</option><option>F-4C Wild Weasel |V [US]</option><option>F-4D Phantom || [US]</option><option>F-4E Phantom || [US]</option><option>F-4J Phantom || [US]</option><option>F-4N Phantom || [US]</option><option>F-8C:D Crusader [US]</option><option>F-8E:H:J Crusader [US]</option><option>Mirage |||0(F) [AUS]</option><option>RA-5C Vigilante [US]</option><option>RF-4B Phantom || [US]</option><option>RF-8A:G Crusader [US]</option><option>RF1-1C Voodoo [US]</option></select>
          </td>
          <td>
            <select><option>신병</option><option>훈련됨</option><option>정규군</option><option selected>베테랑</option><option>탑건</option></select>
          </td>
          <td>0</td>
          <td>
            <div class="status-grid">
              <label>#1</label><label>#2</label>
              <select><option selected></option><option>D</option><option>C</option><option>K</option></select>
              <select><option selected></option><option>D</option><option>C</option><option>K</option></select>
              <label>#3</label><label>#4</label>
              <select><option selected></option><option>D</option><option>C</option><option>K</option></select>
              <select><option selected></option><option>D</option><option>C</option><option>K</option></select>
            </div>
          </td>
          <td><input type="text" value=""></td>
          <td><input type="text" value=""></td>
          <td><input type="text" value=""></td>
          <td><input type="text" value=""></td>
          <td><input type="text" value=""></td>
          <td><input type="text" value=""></td><td><button class="view-btn">보기</button></td><td></td>
        </tr>
        <tr><td colspan="15"><button class="add-row" data-target="us-main-table">+</button></td></tr>
      </tbody>
    </table>

    <!-- 후발 공격대 -->
    <table class="trail" id="us-trail-table">
      <thead>
        <tr><th colspan="15">후발 공격대</th></tr>
        <tr>
          <th>임무</th><th>태스크</th><th>콜싸인</th><th>항공기 유형</th><th>수준</th><th>공격성</th><th>상태</th><th>기총</th><th>IRM</th><th>RHM</th><th>폭탄</th><th>연료</th><th>비고</th><th>ADC</th><th>삭제</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            <select class="fit-width">
              <option>타격</option><option>아이언 핸드</option><option>채프</option><option>재밍</option><option>CSAR</option><option selected>정찰</option><option>MiGCAP</option>
            </select>
          </td>
          <td>
            <select class="fit-width">
              <option>폭격</option><option>SEAD</option><option>CAP</option><option>무장 호위</option><option>구조 지원</option><option selected>정찰</option><option>재밍</option><option>채프 살포</option><option>타격</option>
            </select>
          </td>
          <td><input type="text" value="Delta"></td>
          <td>
            <select><option>A-1H Skyraider [US]</option><option>A-4C Skyhawk [US]</option><option>A-4E:F Skyhawk [US]</option><option>A-6A Intruder [US]</option><option>A-6B Intruder [US]</option><option>A-6C Intruder [US]</option><option>A-7A:B Corsair || [US]</option><option>A-7C:E Corsair || [US]</option><option>A-7D Corsair || [US]</option><option>B-52D Stratofortress [US]</option><option>B-52G Stratofortress [US]</option><option>Canberra MK.20 [AUS]</option><option>EA-1F Electric SPAD [US]</option><option>EA-6A Intruder [US]</option><option>EA-6B Prowler [US]</option><option>EB-66B [US]</option><option>EB-66E [US]</option><option>EF-10B Skynight [US]</option><option>EKA-3B Skywarrior [US]</option><option>F-100D Super Sabre [US]</option><option>F-100F Wild Weasel | [US]</option><option>F-104C Starfighter [US]</option><option>F-105F ThunderChief(2) [US]</option><option>F-105F Thunderchief [US]</option><option>F-105F Wild Weasel ||| [US]</option><option>F-105G Wild Weasel [US]</option><option>F-105G Wild Weasel(2) [US]</option><option>F-111A Aardvark [US]</option><option>F-14A Tomcat [US]</option><option>F-4B Phantom || [US]</option><option>F-4C Wild Weasel |V [US]</option><option>F-4D Phantom || [US]</option><option>F-4E Phantom || [US]</option><option>F-4J Phantom || [US]</option><option>F-4N Phantom || [US]</option><option>F-8C:D Crusader [US]</option><option>F-8E:H:J Crusader [US]</option><option>Mirage |||0(F) [AUS]</option><option>RA-5C Vigilante [US]</option><option>RF-4B Phantom || [US]</option><option>RF-8A:G Crusader [US]</option><option>RF1-1C Voodoo [US]</option></select>
          </td>
          <td>
            <select><option>신병</option><option>훈련됨</option><option selected>정규군</option><option>베테랑</option><option>탑건</option></select>
          </td>
          <td>0</td>
          <td>
            <div class="status-grid">
              <label>#1</label><label>#2</label>
              <select><option selected></option><option>D</option><option>C</option><option>K</option></select>
              <select><option selected></option><option>D</option><option>C</option><option>K</option></select>
              <label>#3</label><label>#4</label>
              <select><option selected></option><option>D</option><option>C</option><option>K</option></select>
              <select><option selected></option><option>D</option><option>C</option><option>K</option></select>
            </div>
          </td>
          <td><input type="text" value=""></td>
          <td><input type="text" value=""></td>
          <td><input type="text" value=""></td>
          <td><input type="text" value=""></td>
          <td><input type="text" value=""></td>
          <td><input type="text" value=""></td><td><button class="view-btn">보기</button></td><td></td>
        </tr>
        <tr><td colspan="15"><button class="add-row" data-target="us-trail-table">+</button></td></tr>
      </tbody>
    </table>
  </div>

  <div id="drv-content" style="display: none;">
    <h2>DRV 비행대 생성기</h2>

    <!-- DRV 요격기 -->
    <table class="lead" id="drv-table">
      <thead>
        <tr><th colspan="13">DRV 요격기</th></tr>
        <tr>
          <th>콜싸인</th><th>항공기 유형</th><th>수준</th><th>공격성</th><th>상태</th><th>기총</th><th>IRM</th><th>RHM</th><th>폭탄</th><th>연료</th><th>비고</th><th>ADC</th><th>삭제</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><input type="text" value="Alpha"></td>
          <td>
            <select><option>MiG-17PF Fresco D [DRV]</option><option>MiG-19S Farmer C [DRV]</option><option>MiG-21F-13 Fishbed C [DRV]</option><option>MiG-21MF Fishbed J [DRV]</option><option>MiG-21PF Fishbed D [DRV]</option><option>MiG-21PFM Fishbed F [DRV]</option></select>
          </td>
          <td>
            <select><option>신병</option><option>훈련됨</option><option>정규군</option><option selected>베테랑</option><option>탑건</option></select>
          </td>
          <td>0</td>
          <td>
            <div class="status-grid">
              <label>#1</label><label>#2</label>
              <select><option selected></option><option>D</option><option>C</option><option>K</option></select>
              <select><option selected></option><option>D</option><option>C</option><option>K</option></select>
              <label>#3</label><label>#4</label>
              <select><option selected></option><option>D</option><option>C</option><option>K</option></select>
              <select><option selected></option><option>D</option><option>C</option><option>K</option></select>
            </div>
          </td>
          <td><input type="text" value=""></td>
          <td><input type="text" value=""></td>
          <td><input type="text" value=""></td>
          <td><input type="text" value=""></td>
          <td><input type="text" value=""></td>
          <td><input type="text" value=""></td>
          <td><button class="view-btn">보기</button></td><td></td>
        </tr>
        <tr><td colspan="13"><button class="add-row" data-target="drv-table">+</button></td></tr>
      </tbody>
    </table>
  </div>

  <!-- Image Modal -->
  <div id="image-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <img id="modal-image" src="" alt="Aircraft Image">
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const usBtn = document.getElementById('us-btn');
      const drvBtn = document.getElementById('drv-btn');
      const usContent = document.getElementById('us-content');
      const drvContent = document.getElementById('drv-content');
      const rowTemplates = {}; // 행 추가를 위한 템플릿 저장소

      // Modal elements
      const modal = document.getElementById('image-modal');
      const modalImage = document.getElementById('modal-image');
      const closeModalBtn = document.querySelector('.close-btn');
      let activeModalButton = null; // 현재 모달을 연 버튼을 추적

      function showContent(type) {
        if (type === 'us') {
          usContent.style.display = 'block';
          drvContent.style.display = 'none';
          usBtn.classList.add('active');
          drvBtn.classList.remove('active');
          location.hash = 'us';
        } else {
          usContent.style.display = 'none';
          drvContent.style.display = 'block';
          drvBtn.classList.add('active');
          usBtn.classList.remove('active');
          location.hash = 'drv';
        }
      }

      usBtn.addEventListener('click', () => showContent('us'));
      drvBtn.addEventListener('click', () => showContent('drv'));

      // 모든 행에 삭제 버튼 추가 및 이벤트 핸들러 바인딩
      function addDeleteButton(row) {
        // 마지막 셀(삭제 열)을 찾음
        const deleteCell = row.querySelector('td:last-child');
        // 해당 셀에 이미 버튼이 없으면 새로 생성
        if (deleteCell && !deleteCell.querySelector('.delete-row')) {
          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = '삭제';
          deleteBtn.className = 'delete-row';
          deleteBtn.onclick = () => row.remove();
          deleteCell.appendChild(deleteBtn);
        }
      }

      // 드롭다운 너비 조절 기능
      function adjustSelectWidth(selectElement) {
        const tempSpan = document.createElement('span');
        tempSpan.style.visibility = 'hidden';
        tempSpan.style.position = 'absolute';
        tempSpan.style.fontSize = getComputedStyle(selectElement).fontSize;
        tempSpan.style.fontFamily = getComputedStyle(selectElement).fontFamily;
        document.body.appendChild(tempSpan);
        tempSpan.textContent = selectElement.options[selectElement.selectedIndex].text;
        // padding과 border를 고려하여 너비 추가
        selectElement.style.width = `${tempSpan.offsetWidth + 30}px`;
        document.body.removeChild(tempSpan);
      }

      // 공격성 계산 로직
      function calculateAggressiveness(skillLevel) {
        const roll = Math.floor(Math.random() * 19) + 2; // 2-20
        const modifiers = {
            "신병": { 2: -3, 3: -3, 4: -3, 5: -3, 6: -2, 7: -2, 8: -2, 9: -2, 10: -1, 11: -1, 12: -1, 13: -1, 14: -1, 15: 0, 16: 0, 17: 0, 18: 0, 19: 1, 20: 2 },
            "훈련됨": { 2: -3, 3: -3, 4: -2, 5: -2, 6: -2, 7: -2, 8: -1, 9: -1, 10: -1, 11: -1, 12: -1, 13: 0, 14: 0, 15: 0, 16: 0, 17: 1, 18: 1, 19: 1, 20: 2 },
            "정규군": { 2: -3, 3: -2, 4: -2, 5: -2, 6: -1, 7: -1, 8: -1, 9: -1, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 1, 16: 1, 17: 1, 18: 1, 19: 2, 20: 2 },
            "베테랑": { 2: -2, 3: -1, 4: -1, 5: -1, 6: 0, 7: 0, 8: 0, 9: 0, 10: 1, 11: 1, 12: 1, 13: 1, 14: 1, 15: 2, 16: 2, 17: 2, 18: 2, 19: 3, 20: 3 },
            "탑건": { 2: -1, 3: 0, 4: 0, 5: 0, 6: 1, 7: 1, 8: 1, 9: 1, 10: 2, 11: 2, 12: 2, 13: 2, 14: 2, 15: 2, 16: 2, 17: 3, 18: 3, 19: 3, 20: 3 }
        };
        // '일반'을 '정규군'으로 매핑
        const skillKey = skillLevel === '일반' ? '정규군' : skillLevel;
        
        if (modifiers[skillKey] && modifiers[skillKey][roll] !== undefined) {
            return modifiers[skillKey][roll];
        }
        return 0; // 기본값
      }

      // 수준 변경 시 공격성 업데이트하는 이벤트 리스너 추가 함수
      function addSkillChangeListener(row) {
        const tableId = row.closest('table').id;
        let skillSelect, aggressivenessCell;

        // 테이블 ID에 따라 올바른 셀 인덱스를 사용합니다.
        switch (tableId) {
          case 'us-lead-table':
            skillSelect = row.querySelector('td:nth-child(5) select');
            aggressivenessCell = row.querySelector('td:nth-child(6)');
            break;
          case 'us-main-table':
          case 'us-trail-table':
            skillSelect = row.querySelector('td:nth-child(5) select');
            aggressivenessCell = row.querySelector('td:nth-child(6)');
            break;
          case 'drv-table':
            skillSelect = row.querySelector('td:nth-child(3) select');
            aggressivenessCell = row.querySelector('td:nth-child(4)');
            break;
          default:
            return; // 해당 없는 테이블이면 종료
        }

        if (skillSelect && aggressivenessCell) {
            skillSelect.addEventListener('change', () => {
                if (skillSelect.value) {
                  const newAggressiveness = calculateAggressiveness(skillSelect.value);
                  aggressivenessCell.textContent = newAggressiveness;
                }
            });
        }
      }

      // 행 추가 기능
      document.querySelectorAll('.add-row').forEach(btn => {
        btn.addEventListener('click', () => {
          const targetId = btn.getAttribute('data-target');
          const table = document.getElementById(targetId);
          const tbody = table.querySelector('tbody');
          const templateRow = rowTemplates[targetId];

          if (!templateRow) return; // 템플릿이 없으면 중단

          const clone = templateRow.cloneNode(true);

          // 복제된 행의 내용 초기화
          clone.querySelectorAll('td').forEach(cell => {
            const select = cell.querySelector('select');
            const input = cell.querySelector('input[type="text"]');
            const buttons = cell.querySelectorAll('button');
            const isDeleteCell = cell === clone.querySelector('td:last-child');

            if (select) {
              select.selectedIndex = 0;
              if (select.classList.contains('fit-width')) {
                // adjustSelectWidth(select);
                select.addEventListener('change', () => adjustSelectWidth(select));
              } 
            } else if (input) {
              input.value = '';
            } else if (buttons.length === 0) {
              cell.textContent = '';
            }
          });
          
          // 복제된 행의 삭제 버튼 내용 비우기 (addDeleteButton에서 새로 만듦)
          const clonedDeleteCell = clone.querySelector('td:last-child');
          if(clonedDeleteCell) clonedDeleteCell.innerHTML = '';

          // 중요: DOM에 먼저 행을 추가해야 .closest()가 정상적으로 작동합니다.
          tbody.insertBefore(clone, tbody.lastElementChild);

          // 삭제 버튼 추가
          addDeleteButton(clone);

          // 새로 추가된 행에 수준 변경 리스너 추가
          addSkillChangeListener(clone);

          // 새로 추가된 행의 보기 버튼에 리스너 추가
          const viewBtnInClone = clone.querySelector('.view-btn');
          if (viewBtnInClone) {
            addViewButtonListener(viewBtnInClone);
          }
        });
      });

      // '보기' 버튼 클릭 이벤트
      function addViewButtonListener(button) {
        button.addEventListener('click', () => {
          // 같은 버튼을 다시 눌렀고 모달이 열려있으면 모달을 닫고 종료
          if (activeModalButton === button && modal.style.display === 'block') {
            modal.style.display = 'none';
            activeModalButton = null;
            return;
          }

          const row = button.closest('tr');
          const aircraftSelect = row.querySelector('td:nth-child(4) select'); // 항공기 유형은 4번째 열
          
          // DRV 테이블은 항공기 유형이 2번째 열
          const isDrv = row.closest('table').id === 'drv-table';
          const aircraftTypeSelect = isDrv 
            ? row.querySelector('td:nth-child(2) select')
            : row.querySelector('td:nth-child(4) select');

          if (aircraftTypeSelect) {
            const aircraftName = aircraftTypeSelect.value;
            const imagePath = isDrv 
              ? `assets/dt/drv/${aircraftName}.jpg`
              : `assets/dt/us/${aircraftName}.jpg`;

            // 이미지가 로드된 후에 위치를 계산하고 모달을 표시합니다.
            modalImage.onload = () => {
              // 모달을 표시하여 너비를 측정한 후, 버튼 아래 오른쪽 정렬로 위치를 조정합니다.
              modal.style.display = 'block'; // 먼저 표시해야 너비를 알 수 있음
              const rect = button.getBoundingClientRect();
              const modalWidth = modal.offsetWidth;

              modal.style.top = `${window.scrollY + rect.bottom + 5}px`; // 5px margin
              modal.style.left = `${window.scrollX + rect.right - modalWidth}px`; // 오른쪽 정렬

              activeModalButton = button; // 현재 열린 모달의 버튼을 저장
              modalImage.onload = null; // 핸들러 정리
            };

            modalImage.src = imagePath; // 이미지 로딩 시작
          }
        });
      }

      // 모달 닫기 이벤트
      closeModalBtn.onclick = () => {
        modal.style.display = 'none';
        activeModalButton = null;
      };
      modalImage.onclick = () => { // 이미지 클릭 시 닫기
        modal.style.display = 'none';
        activeModalButton = null;
      };

      // 초기 로드 시, 각 테이블의 첫 행을 템플릿으로 저장
      document.querySelectorAll('table[id]').forEach(table => {
        const firstDataRow = table.querySelector('tbody tr:not(:last-child)');
        if (firstDataRow) {
          rowTemplates[table.id] = firstDataRow.cloneNode(true);
        }
      });

      // 초기 로드 시 기존 행들에 기능 적용
      document.querySelectorAll('table tbody tr:not(:last-child)').forEach(row => {
        addDeleteButton(row);
        row.querySelectorAll('select.fit-width').forEach(select => {
          adjustSelectWidth(select); // 초기 너비 설정
          select.addEventListener('change', () => adjustSelectWidth(select)); // 변경 시 너비 조절
        });
        row.querySelectorAll('.view-btn').forEach(btn => {
            addViewButtonListener(btn);
        });
        addSkillChangeListener(row);
        // 초기 공격성 값을 설정하기 위해 이벤트를 발생시킵니다.
        const initialSkillSelect = row.querySelector('td:nth-child(5) select, td:nth-child(3) select');
        if (initialSkillSelect && initialSkillSelect.value) initialSkillSelect.dispatchEvent(new Event('change'));
      });

      // 페이지 로드 시 URL 해시 값에 따라 콘텐츠 표시
      const currentHash = window.location.hash;
      if (currentHash === '#drv') {
        showContent('drv');
      } else {
        // 기본값 또는 #us일 경우
        showContent('us');
      }
    });
  </script>

</body>
</html>