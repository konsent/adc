<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Downtown - ADC Generator</title>
  <style>
    body {
      font-family: 'Noto Sans KR', Arial, sans-serif;
      background-color: #fafafa;
      margin: 0;
      padding: 2rem;
    }
    .top-buttons {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      max-width: 420px;
    }
    .top-buttons button {
      flex: 1;
      padding: 0.75rem 0;
      border: none;
      color: white;
      font-weight: bold;
      font-size: 1.2rem;
      border-radius: 6px;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .top-buttons button:not(.active) {
      opacity: 0.6;
    }
    .us { background-color: #2b6cb0; }
    .drv { background-color: #e53e3e; }

    h2 {
      margin-top: 0.5rem;
      margin-bottom: 1rem;
      font-size: 1.3rem;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-bottom: 2rem;
      font-size: 0.9rem;
      table-layout: auto;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      background-color: #fff;
      overflow: hidden;
    }

    th, td {
      padding: 0.75rem 0.5rem;
      text-align: center;
      overflow: hidden;
      white-space: normal;
      border-bottom: 1px solid #e9e9e9;
    }

    th {
      font-weight: 600;
      color: #fff;
      border-bottom-width: 2px;
    }

    #us-lead-table thead th { background-color: #467cf1; }
    #us-main-table thead th { background-color: #5891ee; }
    #us-trail-table thead th { background-color: #76a7e2; }
    #drv-table thead th { background-color: #ef4444; }

    tbody tr:hover {
      background-color: #f9fafb;
    }

    tbody tr:last-child {
      border-bottom: none;
    }
    tbody tr:last-child:hover {
      background-color: transparent;
    }
    tbody tr:last-child td {
      border-bottom: none;
    }

    .add-row {
      cursor: pointer;
      font-size: 1.2rem;
      color: #333;
      border: none;
      background: none;
      padding: 0.5rem 0;
    }

    .view-btn {
      background-color: #f3f3f3;
      border: 1px solid #bdbdbd;
      border-radius: 4px;
      padding: 0.2rem 0.5rem;
      cursor: pointer;
    }
    .delete-row {
      cursor: pointer;
      font-size: 1.2rem;
      color: #e53e3e;
      border: 1px solid #f56565;
      background-color: #fff5f5;
      border-radius: 4px;
      padding: 0.2rem 0.5rem;
      font-size: 0.85rem;
    }

    .input-box {
      display: grid;
      grid-template-columns: 80px 1fr;
      gap: 0.3rem;
      width: 360px;
      margin-bottom: 1.2rem;
    }

    .input-box label {
      background-color: #d9eaf7;
      padding: 0.3rem;
      text-align: center;
      border: 1px solid #bbb;
    }

    .input-box input {
      border: 1px solid #bbb;
      padding: 0.3rem;
    }

    #scenario-container {
      margin-bottom: 1rem;
      max-width: 360px;
    }

    #scenario-name-display {
      font-size: 1.5rem;
      font-weight: bold;
      color: #333;
      cursor: pointer;
      padding: 5px;
      border-radius: 4px;
      transition: background-color 0.2s;
    }

    #scenario-name-display:hover {
      background-color: #f0f0f0;
    }

    #scenario-name-display.placeholder {
      color: #888;
    }

    #scenario-name-input {
      font-size: 1.5rem;
      font-weight: bold;
      border: 1px solid #a0a0a0;
      padding: 5px;
      width: 100%;
      box-sizing: border-box;
      border-radius: 4px;
    }

    td select, td input[type="text"] {
      width: 100%;
      border: 1px solid #d1d5db;
      background-color: white;
      padding: 0.2rem;
      border-radius: 3px;
      font-size: 0.85rem;
      box-sizing: border-box;
    }
    
    td select.fit-width {
        width: auto;
        min-width: 80px;
    }

    .hidden {
      display: none;
    }

    .modal {
      display: none;
      position: absolute;
      z-index: 1000;
      background-color: #fefefe;
      border: 1px solid #888;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      padding: 20px;
    }

    .modal-content {
      max-width: 2400px;
      position: relative;
      text-align: center;
    }

    #modal-image {
      max-height: 90vh;
    }

    .close-btn {
      color: #aaa;
      position: absolute;
      top: 10px;
      right: 25px;
      font-size: 35px;
      font-weight: bold;
      cursor: pointer;
    }

    .status-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2px;
      align-items: center;
      padding: 0;
    }
    .status-item {
      display: flex;
      flex-direction: column;
    }
    .status-header {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 4px;
    }
    .status-header label {
      font-size: 0.9em;
      margin-bottom: -2px;
      font-weight: 500;
    }
    .status-control-btn {
      font-family: monospace;
      font-weight: bold;
      cursor: pointer;
      border: 1px solid #ccc;
      background-color: #f0f0f0;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      line-height: 16px;
      padding: 0;
      font-size: 12px;
    }
    .status-control-btn.remove-status { color: #e53e3e; }
    .status-control-btn.add-status { color: #2b6cb0; }
    .status-item select {
      width: 100%;
    }

    #us-lead-table td:nth-child(n+8):nth-child(-n+11) input,
    #us-main-table td:nth-child(n+8):nth-child(-n+11) input,
    #us-trail-table td:nth-child(n+8):nth-child(-n+11) input,
    #drv-table td:nth-child(n+6):nth-child(-n+9) input,
    #us-lead-table td:nth-child(12) input,
    #us-main-table td:nth-child(12) input,
    #us-trail-table td:nth-child(12) input,
    #drv-table td:nth-child(10) input {
      width: 40px;
    }

    #us-lead-table td:nth-child(3) input,
    #us-main-table td:nth-child(3) input,
    #us-trail-table td:nth-child(3) input,
    #drv-table td:nth-child(1) input,
    #us-lead-table td:nth-child(13) input,
    #us-main-table td:nth-child(13) input,
    #us-trail-table td:nth-child(13) input,
    #drv-table td:nth-child(11) input {
      width: 80px;
    }
  </style>
  <style>
    .aggress-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .aggress-controls {
      display: flex;
      gap: 5px;
      margin-top: 4px;
    }
    .aggress-btn {
      border: 1px solid #ccc;
      background-color: #f0f0f0;
      cursor: pointer;
      font-size: 10px;
      line-height: 1;
      padding: 2px 5px;
      border-radius: 3px;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <div class="top-buttons">
    <button class="us" id="us-btn">US</button>
    <button class="drv" id="drv-btn">DRV</button>
  </div>

  <div id="us-content" style="display: none;">
    <h2>미군 비행대 생성기</h2>

    <div id="scenario-container">
      <h3 id="scenario-name-display" data-placeholder="시나리오 명을 입력하세요"></h3>
      <input type="text" id="scenario-name-input" class="hidden" />
    </div>

    <div class="input-box">
      <label>날짜</label><input type="text" id="us-date" placeholder="YYYY-MM-DD" />
      <label>표적</label><input type="text" id="us-target" placeholder="목표 지점" />
    </div>

    <table class="lead" id="us-lead-table">
      <thead>
        <tr><th colspan="15">선발 공격대</th></tr>
        <tr>
          <th>임무</th><th>태스크</th><th>콜싸인</th><th>항공기 유형</th><th>수준</th><th>공격성</th><th>상태</th><th>기총</th><th>IRM</th><th>RHM</th><th>폭탄</th><th>연료</th><th>비고</th><th>ADC</th><th>삭제</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="15"><button class="add-row" data-target="us-lead-table">+</button></td></tr>
      </tbody>
    </table>

    <table class="main" id="us-main-table">
      <thead>
        <tr><th colspan="15">주 공격대</th></tr>
        <tr>
          <th>임무</th><th>태스크</th><th>콜싸인</th><th>항공기 유형</th><th>수준</th><th>공격성</th><th>상태</th><th>기총</th><th>IRM</th><th>RHM</th><th>폭탄</th><th>연료</th><th>비고</th><th>ADC</th><th>삭제</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="15"><button class="add-row" data-target="us-main-table">+</button></td></tr>
      </tbody>
    </table>

    <table class="trail" id="us-trail-table">
      <thead>
        <tr><th colspan="15">후발 공격대</th></tr>
        <tr>
          <th>임무</th><th>태스크</th><th>콜싸인</th><th>항공기 유형</th><th>수준</th><th>공격성</th><th>상태</th><th>기총</th><th>IRM</th><th>RHM</th><th>폭탄</th><th>연료</th><th>비고</th><th>ADC</th><th>삭제</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="15"><button class="add-row" data-target="us-trail-table">+</button></td></tr>
      </tbody>
    </table>
  </div>

  <div id="drv-content" style="display: none;">
    <h2>DRV 비행대 생성기</h2>

    <table class="lead" id="drv-table">
      <thead>
        <tr><th colspan="13">DRV 요격기</th></tr>
        <tr>
          <th>콜싸인</th><th>항공기 유형</th><th>수준</th><th>공격성</th><th>상태</th><th>기총</th><th>IRM</th><th>RHM</th><th>폭탄</th><th>연료</th><th>비고</th><th>ADC</th><th>삭제</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="13"><button class="add-row" data-target="drv-table">+</button></td></tr>
      </tbody>
    </table>
  </div>

  <div id="image-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <img id="modal-image" src="" alt="Aircraft Image">
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const usBtn = document.getElementById('us-btn');
      const drvBtn = document.getElementById('drv-btn');
      const usContent = document.getElementById('us-content');
      const drvContent = document.getElementById('drv-content');
      const rowTemplates = {};
      const scenarioContainer = document.getElementById('scenario-container');
      const scenarioDisplay = document.getElementById('scenario-name-display');
      const scenarioInput = document.getElementById('scenario-name-input');

      const rowTemplateHTML = {
        'us-lead-table': `<td><select class="fit-width"><option>타격</option><option>아이언 핸드</option><option>채프</option><option>재밍</option><option>CSAR</option><option>정찰</option><option>MiGCAP</option></select></td><td><select class="fit-width"><option>폭격</option><option>SEAD</option><option>CAP</option><option>무장 호위</option><option>구조 지원</option><option>정찰</option><option>재밍</option><option>채프 살포</option><option>타격</option></select></td><td><input type="text" value=""></td><td><select><option>A-1H Skyraider [US]</option><option>A-4C Skyhawk [US]</option><option>A-4E_F Skyhawk [US]</option><option>A-6A Intruder [US]</option><option>A-6B Intruder [US]</option><option>A-6C Intruder [US]</option><option>A-7A_B Corsair 2 [US]</option><option>A-7C_E Corsair 2 [US]</option><option>A-7D Corsair 2 [US]</option><option>B-52D Stratofortress [US]</option><option>B-52G Stratofortress [US]</option><option>Canberra MK.20 [AUS]</option><option>EA-1F Electric SPAD [US]</option><option>EA-6A Intruder [US]</option><option>EA-6B Prowler [US]</option><option>EB-66B [US]</option><option>EB-66E [US]</option><option>EF-10B Skynight [US]</option><option>EKA-3B Skywarrior [US]</option><option>F-100D Super Sabre [US]</option><option>F-100F Wild Weasel 1 [US]</option><option>F-104C Starfighter [US]</option><option>F-105F ThunderChief(2) [US]</option><option>F-105F Thunderchief [US]</option><option>F-105F Wild Weasel 3 [US]</option><option>F-105G Wild Weasel [US]</option><option>F-105G Wild Weasel(2) [US]</option><option>F-111A Aardvark [US]</option><option>F-14A Tomcat [US]</option><option>F-4B Phantom 2 [US]</option><option>F-4C Wild Weasel 4 [US]</option><option>F-4D Phantom 2 [US]</option><option>F-4E Phantom 2 [US]</option><option>F-4J Phantom 2 [US]</option><option>F-4N Phantom 2 [US]</option><option>F-8C_D Crusader [US]</option><option>F-8E_H_J Crusader [US]</option><option>Mirage IIIO(F) [AUS]</option><option>RA-5C Vigilante [US]</option><option>RF-4B Phantom 2 [US]</option><option>RF-8A_G Crusader [US]</option><option>RF1-1C Voodoo [US]</option></select></td><td><select><option>신병</option><option>훈련됨</option><option>정규군</option><option>베테랑</option><option>탑건</option></select></td><td><div class="aggress-container"><span class="aggress-value">0</span><div class="aggress-controls"><button type="button" class="aggress-btn up">▲</button><button type="button" class="aggress-btn down">▼</button></div></div></td><td><div class="status-grid"><div class="status-item" data-status="1"><div class="status-header"><label>#1</label></div><select><option selected></option><option>D</option><option>C</option><option>K</option></select></div><div class="status-item" data-status="2"><div class="status-header"><label>#2</label><button class="status-control-btn remove-status">X</button><button class="status-control-btn add-status" style="display: none;">+</button></div><select><option selected></option><option>D</option><option>C</option><option>K</option></select></div><div class="status-item" data-status="3"><div class="status-header"><label>#3</label><button class="status-control-btn remove-status">X</button><button class="status-control-btn add-status" style="display: none;">+</button></div><select><option selected></option><option>D</option><option>C</option><option>K</option></select></div><div class="status-item" data-status="4"><div class="status-header"><label>#4</label><button class="status-control-btn remove-status">X</button><button class="status-control-btn add-status" style="display: none;">+</button></div><select><option selected></option><option>D</option><option>C</option><option>K</option></select></div></div></td><td><input type="text" value=""></td><td><input type="text" value=""></td><td><input type="text" value=""></td><td><input type="text" value=""></td><td><input type="text" value=""></td><td><input type="text" value=""></td><td><button class="view-btn">보기</button></td><td></td>`,
        'us-main-table': `<td><select class="fit-width"><option>타격</option><option>아이언 핸드</option><option>채프</option><option>재밍</option><option>CSAR</option><option>정찰</option><option>MiGCAP</option></select></td><td><select class="fit-width"><option>폭격</option><option>SEAD</option><option>CAP</option><option>무장 호위</option><option>구조 지원</option><option>정찰</option><option>재밍</option><option>채프 살포</option><option>타격</option></select></td><td><input type="text" value=""></td><td><select><option>A-1H Skyraider [US]</option><option>A-4C Skyhawk [US]</option><option>A-4E_F Skyhawk [US]</option><option>A-6A Intruder [US]</option><option>A-6B Intruder [US]</option><option>A-6C Intruder [US]</option><option>A-7A_B Corsair 2 [US]</option><option>A-7C_E Corsair 2 [US]</option><option>A-7D Corsair 2 [US]</option><option>B-52D Stratofortress [US]</option><option>B-52G Stratofortress [US]</option><option>Canberra MK.20 [AUS]</option><option>EA-1F Electric SPAD [US]</option><option>EA-6A Intruder [US]</option><option>EA-6B Prowler [US]</option><option>EB-66B [US]</option><option>EB-66E [US]</option><option>EF-10B Skynight [US]</option><option>EKA-3B Skywarrior [US]</option><option>F-100D Super Sabre [US]</option><option>F-100F Wild Weasel 1 [US]</option><option>F-104C Starfighter [US]</option><option>F-105F ThunderChief(2) [US]</option><option>F-105F Thunderchief [US]</option><option>F-105F Wild Weasel 3 [US]</option><option>F-105G Wild Weasel [US]</option><option>F-105G Wild Weasel(2) [US]</option><option>F-111A Aardvark [US]</option><option>F-14A Tomcat [US]</option><option>F-4B Phantom 2 [US]</option><option>F-4C Wild Weasel 4 [US]</option><option>F-4D Phantom 2 [US]</option><option>F-4E Phantom 2 [US]</option><option>F-4J Phantom 2 [US]</option><option>F-4N Phantom 2 [US]</option><option>F-8C_D Crusader [US]</option><option>F-8E_H_J Crusader [US]</option><option>Mirage IIIO(F) [AUS]</option><option>RA-5C Vigilante [US]</option><option>RF-4B Phantom 2 [US]</option><option>RF-8A_G Crusader [US]</option><option>RF1-1C Voodoo [US]</option></select></td><td><select><option>신병</option><option>훈련됨</option><option>정규군</option><option>베테랑</option><option>탑건</option></select></td><td><div class="aggress-container"><span class="aggress-value">0</span><div class="aggress-controls"><button type="button" class="aggress-btn up">▲</button><button type="button" class="aggress-btn down">▼</button></div></div></td><td><div class="status-grid"><div class="status-item" data-status="1"><div class="status-header"><label>#1</label></div><select><option selected></option><option>D</option><option>C</option><option>K</option></select></div><div class="status-item" data-status="2"><div class="status-header"><label>#2</label><button class="status-control-btn remove-status">X</button><button class="status-control-btn add-status" style="display: none;">+</button></div><select><option selected></option><option>D</option><option>C</option><option>K</option></select></div><div class="status-item" data-status="3"><div class="status-header"><label>#3</label><button class="status-control-btn remove-status">X</button><button class="status-control-btn add-status" style="display: none;">+</button></div><select><option selected></option><option>D</option><option>C</option><option>K</option></select></div><div class="status-item" data-status="4"><div class="status-header"><label>#4</label><button class="status-control-btn remove-status">X</button><button class="status-control-btn add-status" style="display: none;">+</button></div><select><option selected></option><option>D</option><option>C</option><option>K</option></select></div></div></td><td><input type="text" value=""></td><td><input type="text" value=""></td><td><input type="text" value=""></td><td><input type="text" value=""></td><td><input type="text" value=""></td><td><input type="text" value=""></td><td><button class="view-btn">보기</button></td><td></td>`,
        'us-trail-table': `<td><select class="fit-width"><option>타격</option><option>아이언 핸드</option><option>채프</option><option>재밍</option><option>CSAR</option><option>정찰</option><option>MiGCAP</option></select></td><td><select class="fit-width"><option>폭격</option><option>SEAD</option><option>CAP</option><option>무장 호위</option><option>구조 지원</option><option>정찰</option><option>재밍</option><option>채프 살포</option><option>타격</option></select></td><td><input type="text" value=""></td><td><select><option>A-1H Skyraider [US]</option><option>A-4C Skyhawk [US]</option><option>A-4E_F Skyhawk [US]</option><option>A-6A Intruder [US]</option><option>A-6B Intruder [US]</option><option>A-6C Intruder [US]</option><option>A-7A_B Corsair 2 [US]</option><option>A-7C_E Corsair 2 [US]</option><option>A-7D Corsair 2 [US]</option><option>B-52D Stratofortress [US]</option><option>B-52G Stratofortress [US]</option><option>Canberra MK.20 [AUS]</option><option>EA-1F Electric SPAD [US]</option><option>EA-6A Intruder [US]</option><option>EA-6B Prowler [US]</option><option>EB-66B [US]</option><option>EB-66E [US]</option><option>EF-10B Skynight [US]</option><option>EKA-3B Skywarrior [US]</option><option>F-100D Super Sabre [US]</option><option>F-100F Wild Weasel 1 [US]</option><option>F-104C Starfighter [US]</option><option>F-105F ThunderChief(2) [US]</option><option>F-105F Thunderchief [US]</option><option>F-105F Wild Weasel 3 [US]</option><option>F-105G Wild Weasel [US]</option><option>F-105G Wild Weasel(2) [US]</option><option>F-111A Aardvark [US]</option><option>F-14A Tomcat [US]</option><option>F-4B Phantom 2 [US]</option><option>F-4C Wild Weasel 4 [US]</option><option>F-4D Phantom 2 [US]</option><option>F-4E Phantom 2 [US]</option><option>F-4J Phantom 2 [US]</option><option>F-4N Phantom 2 [US]</option><option>F-8C_D Crusader [US]</option><option>F-8E_H_J Crusader [US]</option><option>Mirage IIIO(F) [AUS]</option><option>RA-5C Vigilante [US]</option><option>RF-4B Phantom 2 [US]</option><option>RF-8A_G Crusader [US]</option><option>RF1-1C Voodoo [US]</option></select></td><td><select><option>신병</option><option>훈련됨</option><option>정규군</option><option>베테랑</option><option>탑건</option></select></td><td><div class="aggress-container"><span class="aggress-value">0</span><div class="aggress-controls"><button type="button" class="aggress-btn up">▲</button><button type="button" class="aggress-btn down">▼</button></div></div></td><td><div class="status-grid"><div class="status-item" data-status="1"><div class="status-header"><label>#1</label></div><select><option selected></option><option>D</option><option>C</option><option>K</option></select></div><div class="status-item" data-status="2"><div class="status-header"><label>#2</label><button class="status-control-btn remove-status">X</button><button class="status-control-btn add-status" style="display: none;">+</button></div><select><option selected></option><option>D</option><option>C</option><option>K</option></select></div><div class="status-item" data-status="3"><div class="status-header"><label>#3</label><button class="status-control-btn remove-status">X</button><button class="status-control-btn add-status" style="display: none;">+</button></div><select><option selected></option><option>D</option><option>C</option><option>K</option></select></div><div class="status-item" data-status="4"><div class="status-header"><label>#4</label><button class="status-control-btn remove-status">X</button><button class="status-control-btn add-status" style="display: none;">+</button></div><select><option selected></option><option>D</option><option>C</option><option>K</option></select></div></div></td><td><input type="text" value=""></td><td><input type="text" value=""></td><td><input type="text" value=""></td><td><input type="text" value=""></td><td><input type="text" value=""></td><td><input type="text" value=""></td><td><button class="view-btn">보기</button></td><td></td>`,
        'drv-table': `<td><input type="text" value=""></td><td><select><option>MiG-17PF Fresco D [DRV]</option><option>MiG-19S Farmer C [DRV]</option><option>MiG-21F-13 Fishbed C [DRV]</option><option>MiG-21MF Fishbed J [DRV]</option><option>MiG-21PF Fishbed D [DRV]</option><option>MiG-21PFM Fishbed F [DRV]</option></select></td><td><select><option>신병</option><option>훈련됨</option><option>정규군</option><option>베테랑</option><option>탑건</option></select></td><td><div class="aggress-container"><span class="aggress-value">0</span><div class="aggress-controls"><button type="button" class="aggress-btn up">▲</button><button type="button" class="aggress-btn down">▼</button></div></div></td><td><div class="status-grid"><div class="status-item" data-status="1"><div class="status-header"><label>#1</label></div><select><option selected></option><option>D</option><option>C</option><option>K</option></select></div><div class="status-item" data-status="2"><div class="status-header"><label>#2</label><button class="status-control-btn remove-status">X</button><button class="status-control-btn add-status" style="display: none;">+</button></div><select><option selected></option><option>D</option><option>C</option><option>K</option></select></div><div class="status-item" data-status="3"><div class="status-header"><label>#3</label><button class="status-control-btn remove-status">X</button><button class="status-control-btn add-status" style="display: none;">+</button></div><select><option selected></option><option>D</option><option>C</option><option>K</option></select></div><div class="status-item" data-status="4"><div class="status-header"><label>#4</label><button class="status-control-btn remove-status">X</button><button class="status-control-btn add-status" style="display: none;">+</button></div><select><option selected></option><option>D</option><option>C</option><option>K</option></select></div></div></td><td><input type="text" value=""></td><td><input type="text" value=""></td><td><input type="text" value=""></td><td><input type="text" value=""></td><td><input type="text" value=""></td><td><input type="text" value=""></td><td><button class="view-btn">보기</button></td><td></td>`
      };

      const modal = document.getElementById('image-modal');
      const modalImage = document.getElementById('modal-image');
      const closeModalBtn = document.querySelector('.close-btn');
      let activeModalButton = null;

      function showContent(type) {
        if (type === 'us') {
          usContent.style.display = 'block';
          drvContent.style.display = 'none';
          usBtn.classList.add('active');
          drvBtn.classList.remove('active');
          location.hash = 'us';
        } else {
          usContent.style.display = 'none';
          drvContent.style.display = 'block';
          drvBtn.classList.add('active');
          usBtn.classList.remove('active');
          location.hash = 'drv';
        }
        saveToLocalStorage();
      }

      usBtn.addEventListener('click', () => showContent('us'));
      drvBtn.addEventListener('click', () => showContent('drv'));

      function addDeleteButton(row) {
        const deleteCell = row.querySelector('td:last-child');
        if (deleteCell && !deleteCell.querySelector('.delete-row')) {
          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = '삭제';
          deleteBtn.className = 'delete-row';
          deleteBtn.onclick = () => {
            row.remove();
            saveToLocalStorage();
          };
          deleteCell.appendChild(deleteBtn);
        }
      }

      function adjustSelectWidth(selectElement) {
        const tempSpan = document.createElement('span');
        tempSpan.style.visibility = 'hidden';
        tempSpan.style.position = 'absolute';
        tempSpan.style.fontSize = getComputedStyle(selectElement).fontSize;
        tempSpan.style.fontFamily = getComputedStyle(selectElement).fontFamily;
        document.body.appendChild(tempSpan);
        tempSpan.textContent = selectElement.options[selectElement.selectedIndex].text;
        selectElement.style.width = `${tempSpan.offsetWidth + 30}px`;
        document.body.removeChild(tempSpan);
      }

      function calculateAggressiveness(skillLevel) {
        const roll = Math.floor(Math.random() * 19) + 2;
        const modifiers = {
          "신병": { 2: -3, 3: -3, 4: -3, 5: -3, 6: -2, 7: -2, 8: -2, 9: -2, 10: -1, 11: -1, 12: -1, 13: -1, 14: -1, 15: 0, 16: 0, 17: 0, 18: 0, 19: 1, 20: 2 },
          "훈련됨": { 2: -3, 3: -3, 4: -2, 5: -2, 6: -2, 7: -2, 8: -1, 9: -1, 10: -1, 11: -1, 12: -1, 13: 0, 14: 0, 15: 0, 16: 0, 17: 1, 18: 1, 19: 1, 20: 2 },
          "정규군": { 2: -3, 3: -2, 4: -2, 5: -2, 6: -1, 7: -1, 8: -1, 9: -1, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 1, 16: 1, 17: 1, 18: 1, 19: 2, 20: 2 },
          "베테랑": { 2: -2, 3: -1, 4: -1, 5: -1, 6: 0, 7: 0, 8: 0, 9: 0, 10: 1, 11: 1, 12: 1, 13: 1, 14: 1, 15: 2, 16: 2, 17: 2, 18: 2, 19: 3, 20: 3 },
          "탑건": { 2: -1, 3: 0, 4: 0, 5: 0, 6: 1, 7: 1, 8: 1, 9: 1, 10: 2, 11: 2, 12: 2, 13: 2, 14: 2, 15: 2, 16: 2, 17: 3, 18: 3, 19: 3, 20: 3 }
        };
        const skillKey = skillLevel === '일반' ? '정규군' : skillLevel;
        return modifiers[skillKey] && modifiers[skillKey][roll] !== undefined ? modifiers[skillKey][roll] : 0;
      }

      function addSkillChangeListener(row) {
        const tableId = row.closest('table').id;
        let skillSelect, aggressivenessCell;
        switch (tableId) {
          case 'us-lead-table':
          case 'us-main-table':
          case 'us-trail-table':
            skillSelect = row.querySelector('td:nth-child(5) select');
            aggressivenessCell = row.querySelector('td:nth-child(6) .aggress-value');
            break;
          case 'drv-table':
            skillSelect = row.querySelector('td:nth-child(3) select');
            aggressivenessCell = row.querySelector('td:nth-child(4) .aggress-value');
            break;
          default:
            return;
        }
        if (skillSelect && aggressivenessCell) {
          skillSelect.addEventListener('change', () => {
            if (skillSelect.value) {
              const newAggressiveness = calculateAggressiveness(skillSelect.value);
              aggressivenessCell.textContent = newAggressiveness;
              saveToLocalStorage();
            }
          });
        }
      }

      function addAggressivenessControls(row) {
        const container = row.querySelector('.aggress-container');
        if (!container) return;

        const valueSpan = container.querySelector('.aggress-value');
        const upBtn = container.querySelector('.aggress-btn.up');
        const downBtn = container.querySelector('.aggress-btn.down');

        upBtn.addEventListener('click', () => {
          let value = parseInt(valueSpan.textContent, 10);
          if (value < 3) {
            valueSpan.textContent = value + 1;
            saveToLocalStorage();
          }
        });

        downBtn.addEventListener('click', () => {
          let value = parseInt(valueSpan.textContent, 10);
          if (value > -3) {
            valueSpan.textContent = value - 1;
            saveToLocalStorage();
          }
        });
      }

      function addStatusGridControls(grid) {
        grid.addEventListener('click', (e) => {
          const target = e.target;
          if (!target.classList.contains('status-control-btn')) return;
          const statusItem = target.closest('.status-item');
          if (!statusItem) return;
          const select = statusItem.querySelector('select');
          const removeBtn = statusItem.querySelector('.remove-status');
          const addBtn = statusItem.querySelector('.add-status');
          if (target.classList.contains('remove-status')) {
            select.style.display = 'none';
            removeBtn.style.display = 'none';
            addBtn.style.display = 'inline-block';
          } else if (target.classList.contains('add-status')) {
            select.style.display = 'block';
            removeBtn.style.display = 'inline-block';
            addBtn.style.display = 'none';
            select.selectedIndex = 0;
          }
          saveToLocalStorage();
        });
        grid.querySelectorAll('.status-item select').forEach(select => {
          select.addEventListener('change', saveToLocalStorage);
        });
      }

      function addRowListeners(row) {
        row.querySelectorAll('select.fit-width').forEach(select => {
          adjustSelectWidth(select);
          select.addEventListener('change', () => {
            adjustSelectWidth(select);
            saveToLocalStorage();
          });
        });
        row.querySelectorAll('select:not(.fit-width)').forEach(select => {
          select.addEventListener('change', saveToLocalStorage);
        });
        row.querySelectorAll('input[type="text"]').forEach(input => {
          input.addEventListener('input', saveToLocalStorage);
        });
        addSkillChangeListener(row);
        addAggressivenessControls(row);
        const viewBtn = row.querySelector('.view-btn');
        if (viewBtn) addViewButtonListener(viewBtn);
        row.querySelectorAll('.status-grid').forEach(addStatusGridControls);
      }

      document.querySelectorAll('.add-row').forEach(btn => {
        btn.addEventListener('click', () => {
          const targetId = btn.getAttribute('data-target');
          const table = document.getElementById(targetId);
          const tbody = table.querySelector('tbody');
          const templateRow = rowTemplates[targetId];
          if (!templateRow) return;
          const clone = templateRow.cloneNode(true);
          clone.querySelectorAll('td:not(:last-child)').forEach(cell => {
            const selects = cell.querySelectorAll('select');
            const input = cell.querySelector('input[type="text"]');
            const button = cell.querySelector('button.view-btn');
            if (selects.length > 0) {
              selects.forEach(select => {
                select.selectedIndex = 0; // Reset select to first option
              });
            } else if (input) {
              input.value = ''; // Clear input fields
            } else if (button) {
              // Preserve view button
              button.textContent = '보기';
              button.className = 'view-btn';
            } else if (cell.querySelector('.aggress-container')) {
              cell.querySelector('.aggress-value').textContent = '0';
            } else if (!cell.querySelector('.status-grid') && !cell.querySelector('.aggress-container')) {
              cell.textContent = ''; // Clear text cells except status grid
            }
          });
          clone.querySelectorAll('.status-item').forEach(item => {
            const select = item.querySelector('select');
            const removeBtn = item.querySelector('.remove-status');
            const addBtn = item.querySelector('.add-status');
            select.style.display = 'block';
            select.selectedIndex = 0;
            if (removeBtn) removeBtn.style.display = 'inline-block';
            if (addBtn) addBtn.style.display = 'none';
          });
          const clonedDeleteCell = clone.querySelector('td:last-child');
          if (clonedDeleteCell) clonedDeleteCell.innerHTML = '';
          tbody.insertBefore(clone, tbody.lastElementChild);
          addDeleteButton(clone);
          addRowListeners(clone);
          // Set initial aggressiveness for new row
          const isDrv = targetId === 'drv-table';
          const skillSelect = clone.querySelector(isDrv ? 'td:nth-child(3) select' : 'td:nth-child(5) select');
          const aggressivenessCell = clone.querySelector(isDrv ? 'td:nth-child(4) .aggress-value' : 'td:nth-child(6) .aggress-value');
          if (skillSelect && aggressivenessCell && skillSelect.value) {
            const newAggressiveness = calculateAggressiveness(skillSelect.value);
            aggressivenessCell.textContent = newAggressiveness;
          }
          saveToLocalStorage();
          console.log(`Added new row to ${targetId}:`, clone);
        });
      });

      function addViewButtonListener(button) {
        button.addEventListener('click', () => {
          if (activeModalButton === button && modal.style.display === 'block') {
            modal.style.display = 'none';
            activeModalButton = null;
            return;
          }
          const row = button.closest('tr');
          const isDrv = row.closest('table').id === 'drv-table';
          const aircraftTypeSelect = isDrv 
            ? row.querySelector('td:nth-child(2) select')
            : row.querySelector('td:nth-child(4) select');
          if (aircraftTypeSelect) {
            const aircraftName = aircraftTypeSelect.value;
            const imagePath = isDrv 
              ? `assets/dt/drv/${aircraftName}.jpg`
              : `assets/dt/us/${aircraftName}.jpg`;
            modalImage.onload = () => {
              modal.style.display = 'block';
              const rect = button.getBoundingClientRect();
              const modalWidth = modal.offsetWidth;
              modal.style.top = `${window.scrollY + rect.bottom + 5}px`;
              modal.style.left = `${window.scrollX + rect.right - modalWidth}px`;
              activeModalButton = button;
              modalImage.onload = null;
            };
            modalImage.src = imagePath;
          }
        });
      }

      closeModalBtn.onclick = () => {
        modal.style.display = 'none';
        activeModalButton = null;
      };
      modalImage.onclick = () => {
        modal.style.display = 'none';
        activeModalButton = null;
      };

      // 시나리오 이름 편집/저장 로직
      function updateScenarioDisplay(text) {
        const placeholder = scenarioDisplay.getAttribute('data-placeholder');
        if (text) {
          scenarioDisplay.textContent = text;
          scenarioDisplay.classList.remove('placeholder');
        } else {
          scenarioDisplay.textContent = placeholder;
          scenarioDisplay.classList.add('placeholder');
        }
      }

      scenarioDisplay.addEventListener('click', () => {
        scenarioDisplay.classList.add('hidden');
        scenarioInput.classList.remove('hidden');
        scenarioInput.value = scenarioDisplay.classList.contains('placeholder') ? '' : scenarioDisplay.textContent;
        scenarioInput.focus();
      });

      scenarioInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          scenarioInput.blur();
        }
      });

      scenarioInput.addEventListener('blur', () => {
        scenarioDisplay.classList.remove('hidden');
        scenarioInput.classList.add('hidden');
        updateScenarioDisplay(scenarioInput.value);
        saveToLocalStorage();
      });

      function initializeTemplates() {
        Object.keys(rowTemplateHTML).forEach(tableId => {
          const tempRow = document.createElement('tr');
          tempRow.innerHTML = rowTemplateHTML[tableId];
          rowTemplates[tableId] = tempRow;
        });
      }

      function saveToLocalStorage() {
        const data = {
          us: {
            scenario: scenarioInput.value || '',
            date: document.getElementById('us-date')?.value || '',
            target: document.getElementById('us-target')?.value || '',
            lead: getTableData('us-lead-table'),
            main: getTableData('us-main-table'),
            trail: getTableData('us-trail-table')
          },
          drv: {
            table: getTableData('drv-table')
          },
          activeTab: usContent.style.display === 'block' ? 'us' : 'drv'
        };
        try {
          localStorage.setItem('downtownGeneratorData', JSON.stringify(data));
          console.log('Data saved to localStorage:', data);
        } catch (e) {
          console.error('Error saving to localStorage:', e);
        }
      }

      function getTableData(tableId) {
        const table = document.getElementById(tableId);
        const rows = table.querySelectorAll('tbody tr:not(:last-child)');
        const data = [];
        rows.forEach(row => {
          const rowData = { cells: [], status: [] };
          row.querySelectorAll('td:not(:last-child)').forEach(cell => {
            const select = cell.querySelector('select');
            const input = cell.querySelector('input[type="text"]');
            const button = cell.querySelector('button.view-btn');
            if (select) {
              rowData.cells.push({ type: 'select', value: select.value });
            } else if (input) {
              rowData.cells.push({ type: 'input', value: input.value });
            } else if (button) {
              rowData.cells.push({ type: 'button', value: '보기' });
            } else if (cell.querySelector('.status-grid')) {
              cell.querySelectorAll('.status-item').forEach(item => {
                const select = item.querySelector('select');
                rowData.status.push({
                  value: select.value,
                  display: select.style.display || 'block'
                });
              });
            } else if (cell.querySelector('.aggress-container')) {
              rowData.cells.push({ type: 'aggress', value: cell.querySelector('.aggress-value').textContent.trim() });
            } else {
              rowData.cells.push({ type: 'text', value: cell.textContent.trim() });
            }
          });
          data.push(rowData);
        });
        return data;
      }

      function loadFromLocalStorage() {
        try {
          const savedData = localStorage.getItem('downtownGeneratorData');
          if (!savedData) {
            console.log('No saved data found in localStorage');
            // 로컬스토리지에 데이터가 없으면 모든 테이블의 tbody를 비웁니다.
            document.querySelectorAll('table[id] tbody').forEach(tbody => {
                const addRowTr = tbody.querySelector('tr:has(.add-row)');
                tbody.innerHTML = '';
                if (addRowTr) tbody.appendChild(addRowTr);
            });
            updateScenarioDisplay('');
            return;
          }
          const data = JSON.parse(savedData);
          console.log('Loaded data from localStorage:', data);

          if (data.us) {
            updateScenarioDisplay(data.us.scenario || '');
            const usDateInput = document.getElementById('us-date');
            const usTargetInput = document.getElementById('us-target');
            if (usDateInput) usDateInput.value = data.us.date || '';
            if (usTargetInput) usTargetInput.value = data.us.target || '';
            restoreTable('us-lead-table', data.us.lead);
            restoreTable('us-main-table', data.us.main);
            restoreTable('us-trail-table', data.us.trail);
          }

          if (data.drv) {
            restoreTable('drv-table', data.drv.table);
          }

          if (data.activeTab) {
            showContent(data.activeTab);
          }
        } catch (e) {
          console.error('Error loading from localStorage:', e);
        }
      }

      function restoreTable(tableId, tableData) {
        if (!tableData || tableData.length === 0) return;
        const table = document.getElementById(tableId);
        const tbody = table.querySelector('tbody');
        tbody.querySelectorAll('tr:not(:last-child)').forEach(row => row.remove());
        const addRowBtnRow = tbody.lastElementChild;
        tableData.forEach(rowData => {
          const templateRow = rowTemplates[tableId];
          if (!templateRow) return;
          const clone = templateRow.cloneNode(true);
          let cellIndex = 0;
          let statusIndex = 0;
          clone.querySelectorAll('td:not(:last-child)').forEach(cell => {
            if (cellIndex < rowData.cells.length) {
              const savedCell = rowData.cells[cellIndex];
              const select = cell.querySelector('select');
              const input = cell.querySelector('input[type="text"]');
              const button = cell.querySelector('button.view-btn');
              if (select && savedCell.type === 'select') {
                select.value = savedCell.value || '';
                if (select.classList.contains('fit-width')) adjustSelectWidth(select);
              } else if (input && savedCell.type === 'input') {
                input.value = savedCell.value || '';
              } else if (button && savedCell.type === 'button') {
                button.textContent = '보기';
                button.className = 'view-btn';
              } else if (cell.querySelector('.status-grid')) {
                cell.querySelectorAll('.status-item').forEach(item => {
                  if (statusIndex < rowData.status.length) {
                    const savedStatus = rowData.status[statusIndex];
                    const select = item.querySelector('select');
                    const removeBtn = item.querySelector('.remove-status');
                    const addBtn = item.querySelector('.add-status');
                    select.value = savedStatus.value || '';
                    select.style.display = savedStatus.display || 'block';
                    removeBtn.style.display = savedStatus.display === 'block' ? 'inline-block' : 'none';
                    addBtn.style.display = savedStatus.display === 'none' ? 'inline-block' : 'none';
                    statusIndex++;
                  }
                });
              } else if (cell.querySelector('.aggress-container') && savedCell.type === 'aggress') {
                cell.querySelector('.aggress-value').textContent = savedCell.value || '0';
              } else {
                cell.textContent = savedCell.value || '';
              }
              cellIndex++;
            }
          });
          const deleteCell = clone.querySelector('td:last-child');
          deleteCell.innerHTML = '';
          tbody.insertBefore(clone, addRowBtnRow);
          addDeleteButton(clone);
          addRowListeners(clone);
        });
      }

      // 템플릿 초기화
      initializeTemplates();

      // 초기 행에 리스너 추가
      document.querySelectorAll('table tbody tr:not(:last-child)').forEach(addRowListeners);


      // US 입력 박스 이벤트
      const usDateInput = document.getElementById('us-date');
      const usTargetInput = document.getElementById('us-target');
      if (usDateInput) usDateInput.addEventListener('input', saveToLocalStorage);
      if (usTargetInput) usTargetInput.addEventListener('input', saveToLocalStorage);

      // 페이지 로드 시 데이터 로드
      loadFromLocalStorage();

      // 로컬 스토리지에 활성 탭 정보가 없으면 URL 해시를 확인하거나 기본값(us)으로 설정
      if (usContent.style.display !== 'block' && drvContent.style.display !== 'block') {
        const hash = location.hash.substring(1);
        const initialTab = hash === 'us' || hash === 'drv' ? hash : 'us';
        showContent(initialTab);
      }
    });
  </script>
</body>
</html>