<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Red Storm - ADC Generator</title>
  <style>
    body {
      font-family: 'Noto Sans KR', Arial, sans-serif;
      background-color: #fafafa;
      margin: 0;
      padding: 2rem;
    }
    .top-buttons {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      max-width: 420px;
    }
    .top-buttons button {
      flex: 1;
      padding: 0.75rem 0;
      border: none;
      color: white;
      font-weight: bold;
      font-size: 1.2rem;
      border-radius: 6px;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .top-buttons button:not(.active) {
      opacity: 0.6;
    }
    .us { background-color: #2b6cb0; }
    .drv { background-color: #e53e3e; }

    h2 {
      margin-top: 0.5rem;
      margin-bottom: 1rem;
      font-size: 1.3rem;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-bottom: 2rem;
      font-size: 0.9rem;
      table-layout: auto;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      background-color: #fff;
      overflow: hidden;
    }

    th, td {
      padding: 0.75rem 0.5rem;
      text-align: center;
      overflow: hidden;
      white-space: normal;
      border-bottom: 1px solid #e9e9e9;
    }

    th {
      font-weight: 600;
      color: #fff;
      border-bottom-width: 2px;
    }

    #us-lead-table thead th { background-color: #467cf1; }
    #us-main-table thead th { background-color: #5891ee; }
    #us-trail-table thead th { background-color: #76a7e2; }
    #drv-table thead th { background-color: #ef4444; }

    tbody tr:hover {
      background-color: #f9fafb;
    }

    tbody tr:last-child {
      border-bottom: none;
    }
    tbody tr:last-child:hover {
      background-color: transparent;
    }
    tbody tr:last-child td {
      border-bottom: none;
    }

    .add-row {
      cursor: pointer;
      font-size: 1.2rem;
      color: #333;
      border: none;
      background: none;
      padding: 0.5rem 0;
    }

    .view-btn {
      background-color: #f3f3f3;
      border: 1px solid #bdbdbd;
      border-radius: 4px;
      padding: 0.2rem 0.5rem;
      cursor: pointer;
    }
    .delete-row {
      cursor: pointer;
      font-size: 1.2rem;
      color: #e53e3e;
      border: 1px solid #f56565;
      background-color: #fff5f5;
      border-radius: 4px;
      padding: 0.2rem 0.5rem;
      font-size: 0.85rem;
    }

    .input-box {
      display: grid;
      grid-template-columns: 80px 1fr;
      gap: 0.3rem;
      width: 360px;
      margin-bottom: 1.2rem;
    }

    .input-box label {
      background-color: #d9eaf7;
      padding: 0.3rem;
      text-align: center;
      border: 1px solid #bbb;
    }

    .input-box input {
      border: 1px solid #bbb;
      padding: 0.3rem;
    }

    #scenario-container {
      margin-bottom: 1rem;
      max-width: 360px;
    }

    #scenario-name-display {
      font-size: 1.5rem;
      font-weight: bold;
      color: #333;
      cursor: pointer;
      padding: 5px;
      border-radius: 4px;
      transition: background-color 0.2s;
    }

    #scenario-name-display:hover {
      background-color: #f0f0f0;
    }

    #scenario-name-display.placeholder {
      color: #888;
    }

    #scenario-name-input {
      font-size: 1.5rem;
      font-weight: bold;
      border: 1px solid #a0a0a0;
      padding: 5px;
      width: 100%;
      box-sizing: border-box;
      border-radius: 4px;
    }

    td select, td input[type="text"] {
      width: 100%;
      border: 1px solid #d1d5db;
      background-color: white;
      padding: 0.2rem;
      border-radius: 3px;
      font-size: 0.85rem;
      box-sizing: border-box;
    }
    
    td select.fit-width {
        width: auto;
        min-width: 80px;
    }

    .hidden {
      display: none;
    }

    .modal {
      display: none;
      position: absolute;
      z-index: 1000;
      background-color: #fefefe;
      border: 1px solid #888;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      padding: 20px;
    }

    .modal-content {
      max-width: 2400px;
      position: relative;
      text-align: center;
    }

    #modal-image {
      max-height: 90vh;
    }

    .close-btn {
      color: #aaa;
      position: absolute;
      top: 10px;
      right: 25px;
      font-size: 35px;
      font-weight: bold;
      cursor: pointer;
    }

    .status-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2px;
      align-items: center;
      padding: 0;
    }
    .status-item {
      display: flex;
      flex-direction: column;
    }
    .status-header {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 4px;
    }
    .status-header label {
      font-size: 0.9em;
      margin-bottom: -2px;
      font-weight: 500;
    }
    .status-control-btn {
      font-family: monospace;
      font-weight: bold;
      cursor: pointer;
      border: 1px solid #ccc;
      background-color: #f0f0f0;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      line-height: 16px;
      padding: 0;
      font-size: 12px;
    }
    .status-control-btn.remove-status { color: #e53e3e; }
    .status-control-btn.add-status { color: #2b6cb0; }
    .status-item select {
      width: 100%;
    }

    #us-lead-table td:nth-child(n+8):nth-child(-n+11) input,
    #us-main-table td:nth-child(n+8):nth-child(-n+11) input,
    #us-trail-table td:nth-child(n+8):nth-child(-n+11) input,
    #drv-table td:nth-child(n+6):nth-child(-n+9) input,
    #us-lead-table td:nth-child(12) input,
    #us-main-table td:nth-child(12) input,
    #us-trail-table td:nth-child(12) input,
    #drv-table td:nth-child(10) input {
      width: 40px;
    }

    #us-lead-table td:nth-child(3) input,
    #us-main-table td:nth-child(3) input,
    #us-trail-table td:nth-child(3) input,
    #drv-table td:nth-child(1) input,
    #us-lead-table td:nth-child(13) input,
    #us-main-table td:nth-child(13) input,
    #us-trail-table td:nth-child(13) input,
    #drv-table td:nth-child(11) input {
      width: 80px;
    }
  </style>
</head>
<body>

  <div class="top-buttons">
    <button class="us" id="us-btn">NATO</button>
    <button class="drv" id="drv-btn">WP</button>
  </div>

  <div id="us-content" style="display: none;">
    <h2>NATO Flight Generator</h2>

    <div id="scenario-container">
      <h3 id="scenario-name-display" data-placeholder="Enter the scenario name"></h3>
      <input type="text" id="scenario-name-input" class="hidden" />
    </div>

    <table class="lead" id="us-lead-table">
      <thead>
        <tr><th colspan="15">NATO Flight</th></tr>
        <tr>
          <th>Mission</th><th>Tasking</th><th>Callsign</th><th>A/C Type</th><th>Quality</th><th>Aggres</th><th>Status</th><th>Gun</th><th>IRM</th><th>RHM</th><th>Bomb</th><th>Fuel</th><th>Note</th><th>ADC</th><th>Del</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="15"><button class="add-row" data-target="us-lead-table">+</button></td></tr>
      </tbody>
    </table>
  </div>

  <div id="drv-content" style="display: none;">
    <h2>WP Flight Generator</h2>

    <table class="lead" id="drv-table">
      <thead>
        <tr><th colspan="15">WP Flight</th></tr>
        <tr>
          <th>Mission</th><th>Tasking</th><th>Callsign</th><th>A/C Type</th><th>Quality</th><th>Aggres</th><th>Status</th><th>Gun</th><th>IRM</th><th>RHM</th><th>Bomb</th><th>Fuel</th><th>Note</th><th>ADC</th><th>Del</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="15"><button class="add-row" data-target="drv-table">+</button></td></tr>
      </tbody>
    </table>
  </div>

  <div id="image-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <img id="modal-image" src="" alt="Aircraft Image">
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const usBtn = document.getElementById('us-btn');
      const drvBtn = document.getElementById('drv-btn');
      const usContent = document.getElementById('us-content');
      const drvContent = document.getElementById('drv-content');
      const rowTemplates = {};
      const scenarioContainer = document.getElementById('scenario-container');
      const scenarioDisplay = document.getElementById('scenario-name-display');
      const scenarioInput = document.getElementById('scenario-name-input');

      const rowTemplateHTML = {
        'us-lead-table': `<td><select class="fit-width"><option>Strike</option><option>Iron Hand</option><option>Chaff</option><option>Jamming</option><option>CSAR</option><option>Recon</option><option>MiGCAP</option></select></td><td><select class="fit-width"><option>Bombing</option><option>SEAD</option><option>CAP</option><option>Armed Escort</option><option>Rescue</option><option>Recon</option><option>Jamming</option><option>Chaff Laying</option><option>Strike</option></select></td><td><input type="text" value=""></td><td><select><option>A-10A Thunderbolt 2 [US]</option><option>A-7D Corsair 2 [US]</option><option>Alpha Jet A [GER]</option><option>B-52G Stratofortress [US]</option><option>Buccaneer S.2B [GBR]</option><option>C-141B Starlifter [US]</option><option>CF-18A Hornet [CAN]</option><option>CF-5A Freedom fighter [CAN]</option><option>EC-130H Compass Call [US]</option><option>EF-111A Raven [US]</option><option>F-104G Starfighter [GER]</option><option>F-111D_E Aardvark [US]</option><option>F-111F Aardvark [US]</option><option>F-117A Nighthawk [US]</option><option>F-15A Eagle [US]</option><option>F-15C Eagle [US]</option><option>F-16A Falcon [BEL]</option><option>F-16A Falcon [NET]</option><option>F-16A Falcon [US]</option><option>F-16C Falcon [US]</option><option>F-4D Phantom 2 [US]</option><option>F-4E Phantom 2 [US]</option><option>F-4F Phantom 2 [GER]</option><option>F-4G Wild Weasel 5 [US]</option><option>Falcon 20F [GBR]</option><option>HFB 320 Hansa Jet [GER]</option><option>Harrier GR.3 [GBR]</option><option>Jaguar GR.1A [GBR]</option><option>Mirage 5BA [BEL]</option><option>Mirage 5BR [BEL]</option><option>NF-5A Freedom Fighter [NET]</option><option>Phantom FGR.2 [GBR]</option><option>RF-4C Phantom 2 [US]</option><option>RF-4E Phantom 2 [GER]</option><option>Tornado F.2A [GBR]</option><option>Tornado GR.1 [GBR]</option><option>Tornado GR.1A [GBR]</option><option>Tornado IDS [GER]</option></select></td><td><select><option>Rookie</option><option>Trained</option><option>Regular</option><option>Veteran</option><option>Topgun</option></select></td><td>0</td><td><div class="status-grid"><div class="status-item" data-status="1"><div class="status-header"><label>#1</label></div><select><option selected></option><option>D</option><option>C</option><option>K</option></select></div><div class="status-item" data-status="2"><div class="status-header"><label>#2</label><button class="status-control-btn remove-status">X</button><button class="status-control-btn add-status" style="display: none;">+</button></div><select><option selected></option><option>D</option><option>C</option><option>K</option></select></div><div class="status-item" data-status="3"><div class="status-header"><label>#3</label><button class="status-control-btn remove-status">X</button><button class="status-control-btn add-status" style="display: none;">+</button></div><select><option selected></option><option>D</option><option>C</option><option>K</option></select></div><div class="status-item" data-status="4"><div class="status-header"><label>#4</label><button class="status-control-btn remove-status">X</button><button class="status-control-btn add-status" style="display: none;">+</button></div><select><option selected></option><option>D</option><option>C</option><option>K</option></select></div></div></td><td><input type="text" value=""></td><td><input type="text" value=""></td><td><input type="text" value=""></td><td><input type="text" value=""></td><td><input type="text" value=""></td><td><input type="text" value=""></td><td><button class="view-btn">Card</button></td><td></td>`,
        'drv-table': `<td><select class="fit-width"><option>Strike</option><option>Iron Hand</option><option>Chaff</option><option>Jamming</option><option>CSAR</option><option>Recon</option><option>MiGCAP</option></select></td><td><select class="fit-width"><option>Bombing</option><option>SEAD</option><option>CAP</option><option>Armed Escort</option><option>Rescue</option><option>Recon</option><option>Jamming</option><option>Chaff Laying</option><option>Strike</option></select></td><td><input type="text" value=""></td><td><select><option>AN-12PP Cub C [WP]</option><option>IL-76MD Candid [WP]</option><option>MiG-21BIS Fishbed L [EGE]</option><option>MiG-21BIS Fishbed N [WP]</option><option>MiG-21M Fishbed J [EGE]</option><option>MiG-21MF Fishbed J [EGE]</option><option>MiG-21R Fishbed H [WP]</option><option>MiG-21SPS Fishbed F [EGE]</option><option>MiG-23BN Flogger H [EGE]</option><option>MiG-23M Flogger B [WP]</option><option>MiG-23MF Flogger B [EGE]</option><option>MiG-23ML Flogger G [EGE]</option><option>MiG-23MLA Flogger G [WP]</option><option>MiG-23MLD Flogger K [WP]</option><option>MiG-25BM Foxbat F [WP]</option><option>MiG-25PD Foxbat E [WP]</option><option>MiG-25RB Foxbat B [WP]</option><option>MiG-27K Flogger J2 [WP]</option><option>MiG-27M Flogger J [WP]</option><option>MiG-29 Fulcrum A [WP]</option><option>Su-17M3R Fitter H [WP]</option><option>Su-17M4 Fitter K [WP]</option><option>Su-22M4 Fitter K [EGE]</option><option>Su-24 Fencer C [WP]</option><option>Su-24M Fencer D [WP]</option><option>Su-24MP Fencer F [WP]</option><option>Su-24MR Fencer E [WP]</option><option>Su-25 Frogfoot A [WP]</option><option>Su-27S Flanker B [WP]</option><option>Tu-16K Badger G [WP]</option><option>Tu-16P Badger J [WP]</option><option>Tu-22KPD Blinder B [WP]</option><option>Tu-22PD Blinder E [WP]</option><option>YAK-28PP Brewer E [WP]</option></select></td><td><select><option>Rookie</option><option>Trained</option><option>Regular</option><option>Veteran</option><option>Topgun</option></select></td><td>0</td><td><div class="status-grid"><div class="status-item" data-status="1"><div class="status-header"><label>#1</label></div><select><option selected></option><option>D</option><option>C</option><option>K</option></select></div><div class="status-item" data-status="2"><div class="status-header"><label>#2</label><button class="status-control-btn remove-status">X</button><button class="status-control-btn add-status" style="display: none;">+</button></div><select><option selected></option><option>D</option><option>C</option><option>K</option></select></div><div class="status-item" data-status="3"><div class="status-header"><label>#3</label><button class="status-control-btn remove-status">X</button><button class="status-control-btn add-status" style="display: none;">+</button></div><select><option selected></option><option>D</option><option>C</option><option>K</option></select></div><div class="status-item" data-status="4"><div class="status-header"><label>#4</label><button class="status-control-btn remove-status">X</button><button class="status-control-btn add-status" style="display: none;">+</button></div><select><option selected></option><option>D</option><option>C</option><option>K</option></select></div></div></td><td><input type="text" value=""></td><td><input type="text" value=""></td><td><input type="text" value=""></td><td><input type="text" value=""></td><td><input type="text" value=""></td><td><input type="text" value=""></td><td><button class="view-btn">Card</button></td><td></td>`,
       };

      const modal = document.getElementById('image-modal');
      const modalImage = document.getElementById('modal-image');
      const closeModalBtn = document.querySelector('.close-btn');
      let activeModalButton = null;

      function showContent(type) {
        if (type === 'us') {
          usContent.style.display = 'block';
          drvContent.style.display = 'none';
          usBtn.classList.add('active');
          drvBtn.classList.remove('active');
          location.hash = 'us';
        } else {
          usContent.style.display = 'none';
          drvContent.style.display = 'block';
          drvBtn.classList.add('active');
          usBtn.classList.remove('active');
          location.hash = 'drv';
        }
        saveToLocalStorage();
      }

      usBtn.addEventListener('click', () => showContent('us'));
      drvBtn.addEventListener('click', () => showContent('drv'));

      function addDeleteButton(row) {
        const deleteCell = row.querySelector('td:last-child');
        if (deleteCell && !deleteCell.querySelector('.delete-row')) {
          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = 'Del';
          deleteBtn.className = 'delete-row';
          deleteBtn.onclick = () => {
            row.remove();
            saveToLocalStorage();
          };
          deleteCell.appendChild(deleteBtn);
        }
      }

      function adjustSelectWidth(selectElement) {
        const tempSpan = document.createElement('span');
        tempSpan.style.visibility = 'hidden';
        tempSpan.style.position = 'absolute';
        tempSpan.style.fontSize = getComputedStyle(selectElement).fontSize;
        tempSpan.style.fontFamily = getComputedStyle(selectElement).fontFamily;
        document.body.appendChild(tempSpan);
        tempSpan.textContent = selectElement.options[selectElement.selectedIndex].text;
        selectElement.style.width = `${tempSpan.offsetWidth + 30}px`;
        document.body.removeChild(tempSpan);
      }

      function calculateAggressiveness(skillLevel) {
        const roll = Math.floor(Math.random() * 19) + 2;
        const modifiers = {
          "Rookie": { 2: -3, 3: -3, 4: -3, 5: -3, 6: -2, 7: -2, 8: -2, 9: -2, 10: -1, 11: -1, 12: -1, 13: -1, 14: -1, 15: 0, 16: 0, 17: 0, 18: 0, 19: 1, 20: 2 },
          "Trained": { 2: -3, 3: -3, 4: -2, 5: -2, 6: -2, 7: -2, 8: -1, 9: -1, 10: -1, 11: -1, 12: -1, 13: 0, 14: 0, 15: 0, 16: 0, 17: 1, 18: 1, 19: 1, 20: 2 },
          "Regular": { 2: -3, 3: -2, 4: -2, 5: -2, 6: -1, 7: -1, 8: -1, 9: -1, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 1, 16: 1, 17: 1, 18: 1, 19: 2, 20: 2 },
          "Veteran": { 2: -2, 3: -1, 4: -1, 5: -1, 6: 0, 7: 0, 8: 0, 9: 0, 10: 1, 11: 1, 12: 1, 13: 1, 14: 1, 15: 2, 16: 2, 17: 2, 18: 2, 19: 3, 20: 3 },
          "Topgun": { 2: -1, 3: 0, 4: 0, 5: 0, 6: 1, 7: 1, 8: 1, 9: 1, 10: 2, 11: 2, 12: 2, 13: 2, 14: 2, 15: 2, 16: 2, 17: 3, 18: 3, 19: 3, 20: 3 }
        };
        const skillKey = skillLevel === '일반' ? 'Regular' : skillLevel;
        return modifiers[skillKey] && modifiers[skillKey][roll] !== undefined ? modifiers[skillKey][roll] : 0;
      }

      function addSkillChangeListener(row) {
        const tableId = row.closest('table').id;
        let skillSelect, aggressivenessCell;
        switch (tableId) {
          case 'us-lead-table':
          case 'us-main-table':
          case 'us-trail-table':
            skillSelect = row.querySelector('td:nth-child(5) select');
            aggressivenessCell = row.querySelector('td:nth-child(6)');
            break;
          case 'drv-table':
            skillSelect = row.querySelector('td:nth-child(5) select');
            aggressivenessCell = row.querySelector('td:nth-child(6)');
            break;
          default:
            return;
        }
        if (skillSelect && aggressivenessCell) {
          skillSelect.addEventListener('change', () => {
            if (skillSelect.value) {
              const newAggressiveness = calculateAggressiveness(skillSelect.value);
              aggressivenessCell.textContent = newAggressiveness;
              saveToLocalStorage();
            }
          });
        }
      }

      function addStatusGridControls(grid) {
        grid.addEventListener('click', (e) => {
          const target = e.target;
          if (!target.classList.contains('status-control-btn')) return;
          const statusItem = target.closest('.status-item');
          if (!statusItem) return;
          const select = statusItem.querySelector('select');
          const removeBtn = statusItem.querySelector('.remove-status');
          const addBtn = statusItem.querySelector('.add-status');
          if (target.classList.contains('remove-status')) {
            select.style.display = 'none';
            removeBtn.style.display = 'none';
            addBtn.style.display = 'inline-block';
          } else if (target.classList.contains('add-status')) {
            select.style.display = 'block';
            removeBtn.style.display = 'inline-block';
            addBtn.style.display = 'none';
            select.selectedIndex = 0;
          }
          saveToLocalStorage();
        });
        grid.querySelectorAll('.status-item select').forEach(select => {
          select.addEventListener('change', saveToLocalStorage);
        });
      }

      function addRowListeners(row) {
        row.querySelectorAll('select.fit-width').forEach(select => {
          adjustSelectWidth(select);
          select.addEventListener('change', () => {
            adjustSelectWidth(select);
            saveToLocalStorage();
          });
        });
        row.querySelectorAll('select:not(.fit-width)').forEach(select => {
          select.addEventListener('change', saveToLocalStorage);
        });
        row.querySelectorAll('input[type="text"]').forEach(input => {
          input.addEventListener('input', saveToLocalStorage);
        });
        addSkillChangeListener(row);
        const viewBtn = row.querySelector('.view-btn');
        if (viewBtn) addViewButtonListener(viewBtn);
        row.querySelectorAll('.status-grid').forEach(addStatusGridControls);
      }

      document.querySelectorAll('.add-row').forEach(btn => {
        btn.addEventListener('click', () => {
          const targetId = btn.getAttribute('data-target');
          const table = document.getElementById(targetId);
          const tbody = table.querySelector('tbody');
          const templateRow = rowTemplates[targetId];
          if (!templateRow) return;
          const clone = templateRow.cloneNode(true);
          clone.querySelectorAll('td:not(:last-child)').forEach(cell => {
            const selects = cell.querySelectorAll('select');
            const input = cell.querySelector('input[type="text"]');
            const button = cell.querySelector('button.view-btn');
            if (selects.length > 0) {
              selects.forEach(select => {
                select.selectedIndex = 0; // Reset select to first option
              });
            } else if (input) {
              input.value = ''; // Clear input fields
            } else if (button) {
              // Preserve view button
              button.textContent = 'Card';
              button.className = 'view-btn';
            } else if (!cell.querySelector('.status-grid')) {
              cell.textContent = ''; // Clear text cells except status grid
            }
          });
          clone.querySelectorAll('.status-item').forEach(item => {
            const select = item.querySelector('select');
            const removeBtn = item.querySelector('.remove-status');
            const addBtn = item.querySelector('.add-status');
            select.style.display = 'block';
            select.selectedIndex = 0;
            if (removeBtn) removeBtn.style.display = 'inline-block';
            if (addBtn) addBtn.style.display = 'none';
          });
          const clonedDeleteCell = clone.querySelector('td:last-child');
          if (clonedDeleteCell) clonedDeleteCell.innerHTML = '';
          tbody.insertBefore(clone, tbody.lastElementChild);
          addDeleteButton(clone);
          addRowListeners(clone);
          // Set initial aggressiveness for new row
          const isDrv = targetId === 'drv-table';
          const skillSelect = clone.querySelector('td:nth-child(5) select');
          const aggressivenessCell = clone.querySelector('td:nth-child(6)');
          if (skillSelect && aggressivenessCell && skillSelect.value) {
            const newAggressiveness = calculateAggressiveness(skillSelect.value);
            aggressivenessCell.textContent = newAggressiveness;
          }
          saveToLocalStorage();
          console.log(`Added new row to ${targetId}:`, clone);
        });
      });

      function addViewButtonListener(button) {
        button.addEventListener('click', () => {
          if (activeModalButton === button && modal.style.display === 'block') {
            modal.style.display = 'none';
            activeModalButton = null;
            return;
          }
          const row = button.closest('tr');
          const isDrv = row.closest('table').id === 'drv-table';
          const aircraftTypeSelect = row.querySelector('td:nth-child(4) select');
          if (aircraftTypeSelect) {
            const aircraftName = aircraftTypeSelect.value;
            const imagePath = isDrv 
              ? `assets/rs_base/wp/flight/${aircraftName}.jpg`
              : `assets/rs_base/nato/flight/${aircraftName}.jpg`;
            modalImage.onload = () => {
              modal.style.display = 'block';
              const rect = button.getBoundingClientRect();
              const modalWidth = modal.offsetWidth;
              modal.style.top = `${window.scrollY + rect.bottom + 5}px`;
              modal.style.left = `${window.scrollX + rect.right - modalWidth}px`;
              activeModalButton = button;
              modalImage.onload = null;
            };
            modalImage.src = imagePath;
          }
        });
      }

      closeModalBtn.onclick = () => {
        modal.style.display = 'none';
        activeModalButton = null;
      };
      modalImage.onclick = () => {
        modal.style.display = 'none';
        activeModalButton = null;
      };

      // 시나리오 이름 편집/저장 로직
      function updateScenarioDisplay(text) {
        const placeholder = scenarioDisplay.getAttribute('data-placeholder');
        if (text) {
          scenarioDisplay.textContent = text;
          scenarioDisplay.classList.remove('placeholder');
        } else {
          scenarioDisplay.textContent = placeholder;
          scenarioDisplay.classList.add('placeholder');
        }
      }

      scenarioDisplay.addEventListener('click', () => {
        scenarioDisplay.classList.add('hidden');
        scenarioInput.classList.remove('hidden');
        scenarioInput.value = scenarioDisplay.classList.contains('placeholder') ? '' : scenarioDisplay.textContent;
        scenarioInput.focus();
      });

      scenarioInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          scenarioInput.blur();
        }
      });

      scenarioInput.addEventListener('blur', () => {
        scenarioDisplay.classList.remove('hidden');
        scenarioInput.classList.add('hidden');
        updateScenarioDisplay(scenarioInput.value);
        saveToLocalStorage();
      });

      function initializeTemplates() {
        Object.keys(rowTemplateHTML).forEach(tableId => {
          const tempRow = document.createElement('tr');
          tempRow.innerHTML = rowTemplateHTML[tableId];
          rowTemplates[tableId] = tempRow;
        });
      }

      function saveToLocalStorage() {
        const data = {
          us: {
            scenario: scenarioInput.value || '',
            date: document.getElementById('us-date')?.value || '',
            target: document.getElementById('us-target')?.value || '',
            nato: getTableData('us-lead-table')
          },
          drv: {
            wp: getTableData('drv-table')
          },
          activeTab: usContent.style.display === 'block' ? 'us' : 'drv'
        };
        try {
          localStorage.setItem('redstormGeneratorData', JSON.stringify(data));
          console.log('Data saved to localStorage:', data);
        } catch (e) {
          console.error('Error saving to localStorage in redstorm:', e);
        }
      }

      function getTableData(tableId) {
        const table = document.getElementById(tableId);
        const rows = table.querySelectorAll('tbody tr:not(:last-child)');
        const data = [];
        rows.forEach(row => {
          const rowData = { cells: [], status: [] };
          row.querySelectorAll('td:not(:last-child)').forEach(cell => {
            const select = cell.querySelector('select');
            const input = cell.querySelector('input[type="text"]');
            const button = cell.querySelector('button.view-btn');
            if (select) {
              rowData.cells.push({ type: 'select', value: select.value });
            } else if (input) {
              rowData.cells.push({ type: 'input', value: input.value });
            } else if (button) {
              rowData.cells.push({ type: 'button', value: 'Card' });
            } else if (cell.querySelector('.status-grid')) {
              cell.querySelectorAll('.status-item').forEach(item => {
                const select = item.querySelector('select');
                rowData.status.push({
                  value: select.value,
                  display: select.style.display || 'block'
                });
              });
            } else {
              rowData.cells.push({ type: 'text', value: cell.textContent.trim() });
            }
          });
          data.push(rowData);
        });
        return data;
      }

      function loadFromLocalStorage() {
        try {
          const savedData = localStorage.getItem('redstormGeneratorData');
          if (!savedData) {
            console.log('No saved data found in localStorage');
            // 로컬스토리지에 데이터가 없으면 모든 테이블의 tbody를 비웁니다.
            document.querySelectorAll('table[id] tbody').forEach(tbody => {
                const addRowTr = tbody.querySelector('tr:has(.add-row)');
                tbody.innerHTML = '';
                if (addRowTr) {
                  tbody.appendChild(addRowTr);
                  // 데이터가 없으면 기본 행 1개씩 추가
                  const addRowButton = addRowTr.querySelector('.add-row');
                  // if (addRowButton) addRowButton.click();
                }
            });
            updateScenarioDisplay('');
            return;
          }
          const data = JSON.parse(savedData);
          console.log('Loaded data from localStorage:', data);

          if (data.us) {
            updateScenarioDisplay(data.us.scenario || '');
            const usDateInput = document.getElementById('us-date');
            const usTargetInput = document.getElementById('us-target');
            if (usDateInput) usDateInput.value = data.us.date || '';
            if (usTargetInput) usTargetInput.value = data.us.target || '';
            restoreTable('us-lead-table', data.us.nato);
          }

          if (data.drv) {
            restoreTable('drv-table', data.drv.wp);
          }

          if (data.activeTab) {
            showContent(data.activeTab);
          }
        } catch (e) {
          console.error('Error loading from localStorage:', e);
        }
      }

      function restoreTable(tableId, tableData) {
        if (!tableData || tableData.length === 0) return;
        const table = document.getElementById(tableId);
        const tbody = table.querySelector('tbody');
        tbody.querySelectorAll('tr:not(:last-child)').forEach(row => row.remove());
        const addRowBtnRow = tbody.lastElementChild;
        tableData.forEach(rowData => {
          const templateRow = rowTemplates[tableId];
          if (!templateRow) return;
          const clone = templateRow.cloneNode(true);
          let cellIndex = 0;
          let statusIndex = 0;
          clone.querySelectorAll('td:not(:last-child)').forEach(cell => {
            if (cellIndex < rowData.cells.length) {
              const savedCell = rowData.cells[cellIndex];
              const select = cell.querySelector('select');
              const input = cell.querySelector('input[type="text"]');
              const button = cell.querySelector('button.view-btn');
              if (select && savedCell.type === 'select') {
                select.value = savedCell.value || '';
                if (select.classList.contains('fit-width')) adjustSelectWidth(select);
              } else if (input && savedCell.type === 'input') {
                input.value = savedCell.value || '';
              } else if (button && savedCell.type === 'button') {
                button.textContent = 'Card';
                button.className = 'view-btn';
              } else if (cell.querySelector('.status-grid')) {
                cell.querySelectorAll('.status-item').forEach(item => {
                  if (statusIndex < rowData.status.length) {
                    const savedStatus = rowData.status[statusIndex];
                    const select = item.querySelector('select');
                    const removeBtn = item.querySelector('.remove-status');
                    const addBtn = item.querySelector('.add-status');
                    select.value = savedStatus.value || '';
                    select.style.display = savedStatus.display || 'block';
                    removeBtn.style.display = savedStatus.display === 'block' ? 'inline-block' : 'none';
                    addBtn.style.display = savedStatus.display === 'none' ? 'inline-block' : 'none';
                    statusIndex++;
                  }
                });
              } else {
                cell.textContent = savedCell.value || '';
              }
              cellIndex++;
            }
          });
          const deleteCell = clone.querySelector('td:last-child');
          deleteCell.innerHTML = '';
          tbody.insertBefore(clone, addRowBtnRow);
          addDeleteButton(clone);
          addRowListeners(clone);
          const aggressivenessCell = clone.querySelector('td:nth-child(6)');
          if (aggressivenessCell && rowData.cells[5]?.type === 'text') {
            aggressivenessCell.textContent = rowData.cells[5].value || '0';
          }
        });
      }

      // 템플릿 초기화
      initializeTemplates();

      // 초기 행에 리스너 추가
      document.querySelectorAll('table tbody tr:not(:last-child)').forEach(addRowListeners);


      // US 입력 박스 이벤트
      const usDateInput = document.getElementById('us-date');
      const usTargetInput = document.getElementById('us-target');
      if (usDateInput) usDateInput.addEventListener('input', saveToLocalStorage);
      if (usTargetInput) usTargetInput.addEventListener('input', saveToLocalStorage);

      // 페이지 로드 시 데이터 로드
      loadFromLocalStorage();

      // URL 해시를 우선으로 확인하고, 없으면 로컬 스토리지, 그것도 없으면 'us'를 기본으로 설정
      const hash = location.hash.substring(1);
      if (hash === 'us' || hash === 'drv') {
        showContent(hash);
      } else if (usContent.style.display !== 'block' && drvContent.style.display !== 'block') {
        // 로컬 스토리지에서 탭을 설정하지 않았고 해시도 없는 경우 기본값으로 'us'를 표시
        showContent('us');
      }
    });
  </script>
</body>
</html>
